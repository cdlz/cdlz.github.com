<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Only For Sunshine~ &#187; Ruby&amp;Testing</title>
	<atom:link href="http://imzc.net/archives/category/rubytesting/feed/" rel="self" type="application/rss+xml" />
	<link>http://imzc.net</link>
	<description>-More Thinking,And Then Just do it~~~</description>
	<lastBuildDate>Thu, 12 Jul 2012 16:18:11 +0000</lastBuildDate>
	<language>zh-CN</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.4.1</generator>
		<item>
		<title>linux下STAF执行失败时的处理</title>
		<link>http://imzc.net/archives/268/</link>
		<comments>http://imzc.net/archives/268/#comments</comments>
		<pubDate>Mon, 09 Jul 2012 03:09:37 +0000</pubDate>
		<dc:creator>imzc</dc:creator>
				<category><![CDATA[Ruby&Testing]]></category>

		<guid isPermaLink="false">http://imzc.net/?p=268</guid>
		<description><![CDATA[最近使用staf时,老是提示xxx.so找不到,按照网上的解决方案设置了,都不行,结果发现问题出现在命令上面: [...]]]></description>
			<content:encoded><![CDATA[<p>最近使用staf时,老是提示xxx.so找不到,按照网上的解决方案设置了,都不行,结果发现问题出现在命令上面:</p>
<p>使用screen防止ssh突然断链,而screen和普通直接登录ssh时不一样.执行命令时,我直接使用了:screen xxx,</p>
<p>猜想:screen command时,在未执行 /etc/profile.从而导致使用xshell登录ssh的环境变量和command通过screen运行时的环境变量不一致.</p>
<p>修复错误: screen -t &#8220;windows name&#8221;后,先执行一下/etc/profile,然后再执行自己的命令.</p>
<p>&nbsp;</p>
<blockquote><p>附上找不到libSTAF.so时,<a href="http://katrina-lxd.i.sohu.com/blog/view/184589263.htm" target="_blank">网上的</a>一般解决方案:</p>
<p>1、启动时：error while loading shared libraries: libSTAF.so: cannot open shared object file: No such file or directory</p>
<p>&nbsp;</p>
<p>解决思路：</p>
<p>（1）、staf默认安装在/usr/local/staf下，如果当前用户不是root用户，确认登录用户有操作该文件夹的权限。</p>
<p>（2）、LD_LIBRARY_PATH未配置staf的库</p>
<p>export LD_LIBRARY_PATH=/usr/local/staf/lib</p>
<p>（3）、LD_LIBRARY_PATH配置成功后运行STAFProc有如下提示：</p>
<p>STAF bin directory not found in PATH, STAF RC: 48, OS RC: 0</p>
<p>配置PATH：PATH=/usr/local/staf/bin:$PATH<br />
export PATH</p>
<p>&nbsp;</p>
<p>2、linux下安装staf之前，</p>
<p>cd /usr/lib</p>
<p>ll libstdc*</p>
<p>如果有C库，不用安装了。</p>
<p>&nbsp;</p>
<p>3、若安装stax，需先安装jvm或者带jvm的staf</p>
<p>&nbsp;</p>
<p>4、配置好stax启动staf时，</p>
<p>Error constructing service, JSTAF, Result: Unable to connect to JVM</p>
<p>并且/usr/local/staf/data/STAF/lang/java/jvm/STAFJVM1中的日志为</p>
<p>Caused by: java.lang.ClassNotFoundException: com.ibm.staf.service.STAFServiceHelper</p>
<p>解决：</p>
<p>（1）确认的位置JSTAF.jar：windows默认在C:\STAF\bin\JSTAF.jar，linux默认在/usr/local/staf/lib/JSTAF.jar。<tt></tt></p>
<p>（2）将JSTAF.jar添加到CLASSPATH中。</p></blockquote>
]]></content:encoded>
			<wfw:commentRss>http://imzc.net/archives/268/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>ruby Rspec测试框架cheetsheet</title>
		<link>http://imzc.net/archives/267/</link>
		<comments>http://imzc.net/archives/267/#comments</comments>
		<pubDate>Wed, 04 Jul 2012 16:57:39 +0000</pubDate>
		<dc:creator>imzc</dc:creator>
				<category><![CDATA[Ruby&Testing]]></category>

		<guid isPermaLink="false">http://imzc.net/?p=267</guid>
		<description><![CDATA[项目使用Rspec测试框架,一堆should等等方法容易忘记,这里收集了下: INSTALL =======  [...]]]></description>
			<content:encoded><![CDATA[<p>项目使用Rspec测试框架,一堆should等等方法容易忘记,这里收集了下:<br />
INSTALL<br />
=======</p>
<p>$ gem install rspec</p>
<p>RSPEC-RAILS<br />
===========</p>
<p>  RAILS-3<br />
  =======</p>
<p>    CONFIGURE THE GEMFILE<br />
    ======================<br />
    group :development, :test do<br />
      gem &#8220;rspec-rails&#8221;, &#8220;~> 2.0&#8243;<br />
    end</p>
<p>    INSTALL THE BUNDLE<br />
    ===============================<br />
    $ bundle install</p>
<p>    BOOTSTRAP THE APP<br />
    =================<br />
    $ ./script/rails generate rspec:install<br />
          create  .rspec<br />
          create  spec<br />
          create  spec/spec_helper.rb<br />
          create  autotest<br />
          create  autotest/discover.rb</p>
<p>  RAILS-2<br />
  =======</p>
<p>    INSTALL<br />
    =======<br />
    $ gem install rspec-rails -v 1.3.3</p>
<p>    BOOTSTRAP THE APP<br />
    =================<br />
    $ ./script/generate rspec<br />
        create  spec<br />
        create  spec/spec_helper.rb<br />
        create  spec/spec.opts<br />
        create  previous_failures.txt<br />
        create  script/spec_server<br />
        create  script/spec</p>
<p>HOW TO USE<br />
==========</p>
<p>  COMMAND LINE<br />
  =============<br />
rspec &#8211;color &#8211;format doc spec/widget_spec.rb</p>
<p>  RAILS 3 (RSPEC 2)<br />
  =============<br />
./rails/generate model User<br />
rake -T spec # lists all rspec rake tasks<br />
rake spec # run all specs<br />
rake spec/models/mymodel_spec.rb # run a single spec file<br />
rake spec/models/mymodel_spec.rb:27 # run a single example or group on line 27</p>
<p>  RAILS 2 (RSPEC 1)<br />
  =============<br />
./script/generate rspec_model User<br />
rake -T spec # lists all rspec rake tasks<br />
rake spec # run all specs<br />
rake spec SPEC=spec/models/mymodel_spec.rb SPEC_OPTS=&#8221;-e \&#8221;should do<br />
something\&#8221;" #run a single spec</p>

<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="code"><pre class="rails" style="font-family:monospace;"><span style="color:#9966CC; font-weight:bold;">module</span> UserSpecHelper
  <span style="color:#9966CC; font-weight:bold;">def</span> valid_user_attributes
    <span style="color:#006600; font-weight:bold;">&#123;</span> <span style="color:#ff3333; font-weight:bold;">:email</span> <span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#996600;">&quot;joe@bloggs.com&quot;</span>,
      <span style="color:#ff3333; font-weight:bold;">:username</span> <span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#996600;">&quot;joebloggs&quot;</span>,
      <span style="color:#ff3333; font-weight:bold;">:password</span> <span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#996600;">&quot;abcdefg&quot;</span><span style="color:#006600; font-weight:bold;">&#125;</span>
  <span style="color:#9966CC; font-weight:bold;">end</span>
<span style="color:#9966CC; font-weight:bold;">end</span>
&nbsp;
&nbsp;
describe <span style="color:#996600;">&quot;A User (in general)&quot;</span> <span style="color:#9966CC; font-weight:bold;">do</span>
  <span style="color:#9966CC; font-weight:bold;">include</span> UserSpecHelper
&nbsp;
  before<span style="color:#006600; font-weight:bold;">&#40;</span>:<span style="color:#5A0A0A; font-weight:bold;">each</span><span style="color:#006600; font-weight:bold;">&#41;</span> <span style="color:#9966CC; font-weight:bold;">do</span>
    <span style="color:#0066ff; font-weight:bold;">@user</span> = User.<span style="color:#5A0A0A; font-weight:bold;">new</span>
  <span style="color:#9966CC; font-weight:bold;">end</span>
&nbsp;
  it <span style="color:#996600;">&quot;should be invalid without a username&quot;</span> <span style="color:#9966CC; font-weight:bold;">do</span>
    pending <span style="color:#996600;">&quot;some other thing we depend on&quot;</span>
    <span style="color:#0066ff; font-weight:bold;">@user</span>.<span style="color:#9900CC;">attributes</span> = valid_user_attributes.<span style="color:#9900CC;">except</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:username</span><span style="color:#006600; font-weight:bold;">&#41;</span>
    <span style="color:#0066ff; font-weight:bold;">@user</span>.<span style="color:#9900CC;">should_not</span> be_valid
    <span style="color:#0066ff; font-weight:bold;">@user</span>.<span style="color:#9900CC;">should</span> have<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006666;">1</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">error_on</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:username</span><span style="color:#006600; font-weight:bold;">&#41;</span>
    <span style="color:#0066ff; font-weight:bold;">@user</span>.<span style="color:#5A0A0A; font-weight:bold;">errors</span>.<span style="color:#9900CC;">on</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:username</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">should</span> == <span style="color:#996600;">&quot;is required&quot;</span>
    <span style="color:#0066ff; font-weight:bold;">@user</span>.<span style="color:#9900CC;">username</span> = <span style="color:#996600;">&quot;someusername&quot;</span>
    <span style="color:#0066ff; font-weight:bold;">@user</span>.<span style="color:#9900CC;">should</span> be_valid
  <span style="color:#9966CC; font-weight:bold;">end</span>
<span style="color:#9966CC; font-weight:bold;">end</span></pre></td></tr></table></div>

<p>EXPECTATIONS<br />
=====================</p>

<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="code"><pre class="rails" style="font-family:monospace;">target.<span style="color:#9900CC;">should</span> satisfy <span style="color:#006600; font-weight:bold;">&#123;</span><span style="color:#006600; font-weight:bold;">|</span>arg<span style="color:#006600; font-weight:bold;">|</span> ...<span style="color:#006600; font-weight:bold;">&#125;</span>
target.<span style="color:#9900CC;">should_not</span> satisfy <span style="color:#006600; font-weight:bold;">&#123;</span><span style="color:#006600; font-weight:bold;">|</span>arg<span style="color:#006600; font-weight:bold;">|</span> ...<span style="color:#006600; font-weight:bold;">&#125;</span>
&nbsp;
target.<span style="color:#9900CC;">should</span> equal <span style="color:#006600; font-weight:bold;">&lt;</span>value<span style="color:#006600; font-weight:bold;">&gt;</span>
target.<span style="color:#9900CC;">should_not</span> equal <span style="color:#006600; font-weight:bold;">&lt;</span>value<span style="color:#006600; font-weight:bold;">&gt;</span>
&nbsp;
target.<span style="color:#9900CC;">should</span> be_close <span style="color:#006600; font-weight:bold;">&lt;</span>value<span style="color:#006600; font-weight:bold;">&gt;</span>, <span style="color:#006600; font-weight:bold;">&lt;</span>tolerance<span style="color:#006600; font-weight:bold;">&gt;</span>
target.<span style="color:#9900CC;">should_not</span> be_close <span style="color:#006600; font-weight:bold;">&lt;</span>value<span style="color:#006600; font-weight:bold;">&gt;</span>, <span style="color:#006600; font-weight:bold;">&lt;</span>tolerance<span style="color:#006600; font-weight:bold;">&gt;</span>
&nbsp;
target.<span style="color:#9900CC;">should</span> be <span style="color:#006600; font-weight:bold;">&lt;</span>value<span style="color:#006600; font-weight:bold;">&gt;</span>
target.<span style="color:#9900CC;">should_not</span> be <span style="color:#006600; font-weight:bold;">&lt;</span>value<span style="color:#006600; font-weight:bold;">&gt;</span>
&nbsp;
target.<span style="color:#9900CC;">should</span> predicate <span style="color:#006600; font-weight:bold;">&#91;</span>optional args<span style="color:#006600; font-weight:bold;">&#93;</span>
target.<span style="color:#9900CC;">should</span> be_predicate <span style="color:#006600; font-weight:bold;">&#91;</span>optional args<span style="color:#006600; font-weight:bold;">&#93;</span>
target.<span style="color:#9900CC;">should_not</span> predicate <span style="color:#006600; font-weight:bold;">&#91;</span>optional args<span style="color:#006600; font-weight:bold;">&#93;</span>
target.<span style="color:#9900CC;">should_not</span> be_predicate <span style="color:#006600; font-weight:bold;">&#91;</span>optional args<span style="color:#006600; font-weight:bold;">&#93;</span>
&nbsp;
target.<span style="color:#9900CC;">should</span> be <span style="color:#006600; font-weight:bold;">&lt;</span> <span style="color:#006666;">6</span>
target.<span style="color:#9900CC;">should</span> == <span style="color:#006666;">5</span>
target.<span style="color:#9900CC;">should</span> be_between<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006666;">1</span>, <span style="color:#006666;">10</span><span style="color:#006600; font-weight:bold;">&#41;</span>
target.<span style="color:#9900CC;">should_not</span> == <span style="color:#996600;">'Samantha'</span>
&nbsp;
target.<span style="color:#9900CC;">should</span> match <span style="color:#006600; font-weight:bold;">&lt;</span>regex<span style="color:#006600; font-weight:bold;">&gt;</span>
target.<span style="color:#9900CC;">should_not</span> match <span style="color:#006600; font-weight:bold;">&lt;</span>regex<span style="color:#006600; font-weight:bold;">&gt;</span>
&nbsp;
target.<span style="color:#9900CC;">should</span> be_an_instance_of <span style="color:#006600; font-weight:bold;">&lt;</span>class<span style="color:#006600; font-weight:bold;">&gt;</span>
target.<span style="color:#9900CC;">should_not</span> be_an_instance_of <span style="color:#006600; font-weight:bold;">&lt;</span>class<span style="color:#006600; font-weight:bold;">&gt;</span>
&nbsp;
target.<span style="color:#9900CC;">should</span> be_a_kind_of <span style="color:#006600; font-weight:bold;">&lt;</span>class<span style="color:#006600; font-weight:bold;">&gt;</span>
target.<span style="color:#9900CC;">should_not</span> be_a_kind_of <span style="color:#006600; font-weight:bold;">&lt;</span>class<span style="color:#006600; font-weight:bold;">&gt;</span>
&nbsp;
target.<span style="color:#9900CC;">should</span> <span style="color:#5A0A0A; font-weight:bold;">respond_to</span> <span style="color:#006600; font-weight:bold;">&lt;</span>symbol<span style="color:#006600; font-weight:bold;">&gt;</span>
target.<span style="color:#9900CC;">should_not</span> <span style="color:#5A0A0A; font-weight:bold;">respond_to</span> <span style="color:#006600; font-weight:bold;">&lt;</span>symbol<span style="color:#006600; font-weight:bold;">&gt;</span>
&nbsp;
<span style="color:#CC0066; font-weight:bold;">lambda</span> <span style="color:#006600; font-weight:bold;">&#123;</span>a_call<span style="color:#006600; font-weight:bold;">&#125;</span>.<span style="color:#9900CC;">should</span> raise_error
<span style="color:#CC0066; font-weight:bold;">lambda</span> <span style="color:#006600; font-weight:bold;">&#123;</span>a_call<span style="color:#006600; font-weight:bold;">&#125;</span>.<span style="color:#9900CC;">should</span> raise_error<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006600; font-weight:bold;">&lt;</span>exception<span style="color:#006600; font-weight:bold;">&gt;</span> <span style="color:#006600; font-weight:bold;">&#91;</span>, message<span style="color:#006600; font-weight:bold;">&#93;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
<span style="color:#CC0066; font-weight:bold;">lambda</span> <span style="color:#006600; font-weight:bold;">&#123;</span>a_call<span style="color:#006600; font-weight:bold;">&#125;</span>.<span style="color:#9900CC;">should_not</span> raise_error
<span style="color:#CC0066; font-weight:bold;">lambda</span> <span style="color:#006600; font-weight:bold;">&#123;</span>a_call<span style="color:#006600; font-weight:bold;">&#125;</span>.<span style="color:#9900CC;">should_not</span> raise_error<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006600; font-weight:bold;">&lt;</span>exception<span style="color:#006600; font-weight:bold;">&gt;</span> <span style="color:#006600; font-weight:bold;">&#91;</span>, message<span style="color:#006600; font-weight:bold;">&#93;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
<span style="color:#CC0066; font-weight:bold;">lambda</span> <span style="color:#006600; font-weight:bold;">&#123;</span>a_call<span style="color:#006600; font-weight:bold;">&#125;</span>.<span style="color:#9900CC;">should</span> change<span style="color:#006600; font-weight:bold;">&#40;</span>instance, method<span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">from</span><span style="color:#006600; font-weight:bold;">&#40;</span>number<span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">to</span><span style="color:#006600; font-weight:bold;">&#40;</span>number<span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
<span style="color:#CC0066; font-weight:bold;">proc</span>.<span style="color:#9900CC;">should</span> throw <span style="color:#006600; font-weight:bold;">&lt;</span>symbol<span style="color:#006600; font-weight:bold;">&gt;</span>
<span style="color:#CC0066; font-weight:bold;">proc</span>.<span style="color:#9900CC;">should_not</span> throw <span style="color:#006600; font-weight:bold;">&lt;</span>symbol<span style="color:#006600; font-weight:bold;">&gt;</span>
&nbsp;
target.<span style="color:#9900CC;">should</span> <span style="color:#9966CC; font-weight:bold;">include</span> <span style="color:#006600; font-weight:bold;">&lt;</span>object<span style="color:#006600; font-weight:bold;">&gt;</span>
target.<span style="color:#9900CC;">should_not</span> <span style="color:#9966CC; font-weight:bold;">include</span> <span style="color:#006600; font-weight:bold;">&lt;</span>object<span style="color:#006600; font-weight:bold;">&gt;</span>
&nbsp;
target.<span style="color:#9900CC;">should</span> have<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006600; font-weight:bold;">&lt;</span>number<span style="color:#006600; font-weight:bold;">&gt;</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">things</span>
target.<span style="color:#9900CC;">should</span> have_at_least<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006600; font-weight:bold;">&lt;</span>number<span style="color:#006600; font-weight:bold;">&gt;</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">things</span>
target.<span style="color:#9900CC;">should</span> have_at_most<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006600; font-weight:bold;">&lt;</span>number<span style="color:#006600; font-weight:bold;">&gt;</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">things</span>
&nbsp;
target.<span style="color:#9900CC;">should</span> have<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006600; font-weight:bold;">&lt;</span>number<span style="color:#006600; font-weight:bold;">&gt;</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">errors_on</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:field</span><span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
expect <span style="color:#006600; font-weight:bold;">&#123;</span> thing.<span style="color:#9900CC;">approve</span>! <span style="color:#006600; font-weight:bold;">&#125;</span>.<span style="color:#9900CC;">to</span> change<span style="color:#006600; font-weight:bold;">&#40;</span>thing, <span style="color:#ff3333; font-weight:bold;">:status</span><span style="color:#006600; font-weight:bold;">&#41;</span>.
    <span style="color:#9900CC;">from</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#6666ff; font-weight:bold;">Status::AWAITING_APPROVAL</span><span style="color:#006600; font-weight:bold;">&#41;</span>.
    <span style="color:#9900CC;">to</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#6666ff; font-weight:bold;">Status::APPROVED</span><span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
expect <span style="color:#006600; font-weight:bold;">&#123;</span> thing.<span style="color:#5A0A0A; font-weight:bold;">destroy</span> <span style="color:#006600; font-weight:bold;">&#125;</span>.<span style="color:#9900CC;">to</span> change<span style="color:#006600; font-weight:bold;">&#40;</span>Thing, :<span style="color:#5A0A0A; font-weight:bold;">count</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">by</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006600; font-weight:bold;">-</span><span style="color:#006666;">1</span><span style="color:#006600; font-weight:bold;">&#41;</span></pre></td></tr></table></div>

<p>Mocks and Stubs(打桩)<br />
===============</p>

<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre class="rails" style="font-family:monospace;">user_mock = mock <span style="color:#996600;">&quot;User&quot;</span>
user_mock.<span style="color:#9900CC;">should_receive</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:authenticate</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">with</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;password&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">and_return</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#0000FF; font-weight:bold;">true</span><span style="color:#006600; font-weight:bold;">&#41;</span>
user_mock.<span style="color:#9900CC;">should_receive</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:coffee</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">exactly</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006666;">3</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">times</span>.<span style="color:#9900CC;">and_return</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:americano</span><span style="color:#006600; font-weight:bold;">&#41;</span>
user_mock.<span style="color:#9900CC;">should_receive</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:coffee</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">exactly</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006666;">5</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">times</span>.<span style="color:#9900CC;">and_raise</span><span style="color:#006600; font-weight:bold;">&#40;</span>NotEnoughCoffeeExcep
ion<span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
people_stub = mock <span style="color:#996600;">&quot;people&quot;</span>
people_stub.<span style="color:#9900CC;">stub</span>!<span style="color:#006600; font-weight:bold;">&#40;</span>:<span style="color:#5A0A0A; font-weight:bold;">each</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">and_yield</span><span style="color:#006600; font-weight:bold;">&#40;</span>mock_user<span style="color:#006600; font-weight:bold;">&#41;</span>
people_stub.<span style="color:#9900CC;">stub</span>!<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:bad_method</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">and_raise</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#CC00FF; font-weight:bold;">RuntimeError</span><span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
user_stub = mock_model<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;User&quot;</span>, <span style="color:#ff3333; font-weight:bold;">:id</span> <span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#006666;">23</span>, <span style="color:#ff3333; font-weight:bold;">:username</span> <span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#996600;">&quot;pat&quot;</span>, <span style="color:#ff3333; font-weight:bold;">:email</span> <span style="color:#006600; font-weight:bold;">=&gt;</span>
<span style="color:#996600;">&quot;pat@example.com&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
my_instance.<span style="color:#9900CC;">stub</span>!<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:msg</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">and_return</span><span style="color:#006600; font-weight:bold;">&#40;</span>value<span style="color:#006600; font-weight:bold;">&#41;</span>
MyClass.<span style="color:#9900CC;">stub</span>!<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:msg</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">and_return</span><span style="color:#006600; font-weight:bold;">&#40;</span>value<span style="color:#006600; font-weight:bold;">&#41;</span></pre></td></tr></table></div>

<p>Examples (in the real world)</p>
<p>============================</p>
<p>http://madhatted.com/2008/7/10/rspec-real-world-testing</p>
<p>presentation: http://kerryb.github.com/iprug-rspec-presentation/#31<br />
&nbsp;</p>
]]></content:encoded>
			<wfw:commentRss>http://imzc.net/archives/267/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>使用windows api实现屏幕截图并复制到剪贴板</title>
		<link>http://imzc.net/archives/253/</link>
		<comments>http://imzc.net/archives/253/#comments</comments>
		<pubDate>Mon, 23 Apr 2012 11:10:43 +0000</pubDate>
		<dc:creator>imzc</dc:creator>
				<category><![CDATA[C/C++]]></category>
		<category><![CDATA[Ruby&Testing]]></category>

		<guid isPermaLink="false">http://imzc.net/?p=253</guid>
		<description><![CDATA[最新自动化项目需要使用屏幕截图功能,本来通过autoit发送printscreen键,然后从剪贴板copy出来 [...]]]></description>
			<content:encoded><![CDATA[<p>最新自动化项目需要使用屏幕截图功能,本来通过autoit发送printscreen键,然后从剪贴板copy出来即可.</p>

<div class="wp_syntax"><div class="code"><pre class="ruby" style="font-family:monospace;">    <span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">&quot;win32ole&quot;</span>
    t = WIN32OLE.<span style="color:#9900CC;">new</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;AutoItX3.Control&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
    t.<span style="color:#9900CC;">Send</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;{PRINTSCREEN}&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>   
	<span style="color:#CC0066; font-weight:bold;">sleep</span> <span style="color:#006666;">1</span>
	picture=<span style="color:#6666ff; font-weight:bold;">Win32::Clipboard</span>.<span style="color:#9900CC;">data</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#6666ff; font-weight:bold;">Win32::Clipboard::DIB</span><span style="color:#006600; font-weight:bold;">&#41;</span> 
	<span style="color:#6666ff; font-weight:bold;">ATT::KeyLog</span>.<span style="color:#9900CC;">info</span> <span style="color:#996600;">&quot;pictrue:#{picture.slice(0..10)}&quot;</span> 
	<span style="color:#CC00FF; font-weight:bold;">File</span>.<span style="color:#CC0066; font-weight:bold;">open</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;xxx.bmp&quot;</span>,<span style="color:#996600;">&quot;wb&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span><span style="color:#9966CC; font-weight:bold;">do</span> <span style="color:#006600; font-weight:bold;">|</span>f<span style="color:#006600; font-weight:bold;">|</span>
    f.<span style="color:#9900CC;">write</span><span style="color:#006600; font-weight:bold;">&#40;</span>picture<span style="color:#006600; font-weight:bold;">&#41;</span>
	<span style="color:#9966CC; font-weight:bold;">end</span></pre></div></div>

<p>&nbsp;</p>
<p>但是此方法有一定风险,比如在远程桌面连入时,很容易和外部PC的剪贴板混乱.<br />
 因此有了使用原始API截图保存的需求.<br />
使用vs2005创建win32控制台程序,勾选ATL即可.注意工程选项,直接静态编译,使程序能适应各个PC.<br />
下面是源码:<br />
带参数时,保存到对应路径,同时复制到剪贴板.<br />
不带参数时,仅复制到剪贴板.</p>

<div class="wp_syntax"><div class="code"><pre class="cpp" style="font-family:monospace;"><span style="color: #000040;">&amp;</span>nbsp<span style="color: #008080;">;</span>
<span style="color: #666666;">// cap.cpp : 定义控制台应用程序的入口点。</span>
<span style="color: #666666;">//</span>
&nbsp;
<span style="color: #339900;">#include &quot;stdafx.h&quot;  </span>
&nbsp;
<span style="color: #339900;">#include &lt;windows.h&gt;  </span>
<span style="color: #339900;">#include &lt;atlimage.h&gt;  </span>
&nbsp;
&nbsp;
CString GetSuffix<span style="color: #008000;">&#40;</span>CString strFileName<span style="color: #008000;">&#41;</span> 
<span style="color: #008000;">&#123;</span> 
	<span style="color: #0000ff;">return</span> strFileName.<span style="color: #007788;">Right</span><span style="color: #008000;">&#40;</span>strFileName.<span style="color: #007788;">GetLength</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #000040;">-</span>strFileName.<span style="color: #007788;">ReverseFind</span><span style="color: #008000;">&#40;</span><span style="color: #FF0000;">'.'</span><span style="color: #008000;">&#41;</span><span style="color: #000040;">-</span><span style="color: #0000dd;">1</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span> 
<span style="color: #008000;">&#125;</span>
&nbsp;
&nbsp;
<span style="color: #0000ff;">int</span> _tmain<span style="color: #008000;">&#40;</span><span style="color: #0000ff;">int</span> argc, _TCHAR<span style="color: #000040;">*</span> argv<span style="color: #008000;">&#91;</span><span style="color: #008000;">&#93;</span><span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
&nbsp;
		wprintf<span style="color: #008000;">&#40;</span>_T<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;Useage:<span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\
</span>1.capture.exe  jpg_path (Save bmp and copy  to clipboard.)<span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\
</span>2.capture.exe (Only copy bmp to your current clipboard.)<span style="color: #000099; font-weight: bold;">\n</span><span style="color: #000099; font-weight: bold;">\
</span>@zc,2012.4.21.&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
&nbsp;
&nbsp;
&nbsp;
&nbsp;
		HWND hwnd <span style="color: #000080;">=</span> <span style="color: #008080;">::</span><span style="color: #007788;">GetDesktopWindow</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  
		HDC hDC <span style="color: #000080;">=</span> <span style="color: #008080;">::</span><span style="color: #007788;">GetDC</span><span style="color: #008000;">&#40;</span>hwnd<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span> <span style="color: #666666;">//根据窗口来确定截图的大概位置</span>
&nbsp;
		RECT rect<span style="color: #008080;">;</span>  
		<span style="color: #008080;">::</span><span style="color: #007788;">GetClientRect</span><span style="color: #008000;">&#40;</span>hwnd, <span style="color: #000040;">&amp;</span>rect<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  
		HDC hDCMem <span style="color: #000080;">=</span> <span style="color: #008080;">::</span><span style="color: #007788;">CreateCompatibleDC</span><span style="color: #008000;">&#40;</span>hDC<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>   
&nbsp;
		HBITMAP hBitMap <span style="color: #000080;">=</span> <span style="color: #008080;">::</span><span style="color: #007788;">CreateCompatibleBitmap</span><span style="color: #008000;">&#40;</span>hDC, rect.<span style="color: #007788;">right</span>, rect.<span style="color: #007788;">bottom</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  
		HBITMAP hOldMap <span style="color: #000080;">=</span> <span style="color: #008000;">&#40;</span>HBITMAP<span style="color: #008000;">&#41;</span><span style="color: #008080;">::</span><span style="color: #007788;">SelectObject</span><span style="color: #008000;">&#40;</span>hDCMem, hBitMap<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  
&nbsp;
		<span style="color: #008080;">::</span><span style="color: #007788;">BitBlt</span><span style="color: #008000;">&#40;</span>hDCMem, <span style="color: #0000dd;">0</span>, <span style="color: #0000dd;">0</span>, rect.<span style="color: #007788;">right</span>, rect.<span style="color: #007788;">bottom</span>, hDC, <span style="color: #0000dd;">0</span>, <span style="color: #0000dd;">0</span>, SRCCOPY<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span> <span style="color: #666666;">//红色部分确定图片的大小位置</span>
&nbsp;
		CImage image<span style="color: #008080;">;</span>  
		image.<span style="color: #007788;">Attach</span><span style="color: #008000;">&#40;</span>hBitMap<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  
&nbsp;
		<span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span>argc<span style="color: #000080;">==</span><span style="color: #0000dd;">2</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#123;</span>
			GUID imageFormat <span style="color: #000080;">=</span> Gdiplus<span style="color: #008080;">::</span><span style="color: #007788;">ImageFormatBMP</span><span style="color: #008080;">;</span>
			CString suffix <span style="color: #000080;">=</span> GetSuffix<span style="color: #008000;">&#40;</span>argv<span style="color: #008000;">&#91;</span><span style="color: #0000dd;">1</span><span style="color: #008000;">&#93;</span><span style="color: #008000;">&#41;</span>.<span style="color: #007788;">MakeLower</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
			<span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span>suffix.<span style="color: #007788;">Compare</span><span style="color: #008000;">&#40;</span>_T<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;jpg&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #000080;">==</span><span style="color: #0000dd;">0</span><span style="color: #008000;">&#41;</span>
			<span style="color: #008000;">&#123;</span>
				imageFormat<span style="color: #000080;">=</span> Gdiplus<span style="color: #008080;">::</span><span style="color: #007788;">ImageFormatJPEG</span><span style="color: #008080;">;</span> 
				wprintf<span style="color: #008000;">&#40;</span>_T<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;img type:jpg&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span> 
			<span style="color: #008000;">&#125;</span><span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span>suffix.<span style="color: #007788;">Compare</span><span style="color: #008000;">&#40;</span>_T<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;png&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #000080;">==</span><span style="color: #0000dd;">0</span><span style="color: #008000;">&#41;</span>
			<span style="color: #008000;">&#123;</span>
				imageFormat<span style="color: #000080;">=</span> Gdiplus<span style="color: #008080;">::</span><span style="color: #007788;">ImageFormatPNG</span><span style="color: #008080;">;</span>
				wprintf<span style="color: #008000;">&#40;</span>_T<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;img type:png&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span> 
			<span style="color: #008000;">&#125;</span><span style="color: #0000ff;">else</span>  
			<span style="color: #008000;">&#123;</span>
				imageFormat<span style="color: #000080;">=</span> Gdiplus<span style="color: #008080;">::</span><span style="color: #007788;">ImageFormatBMP</span><span style="color: #008080;">;</span>
				wprintf<span style="color: #008000;">&#40;</span>_T<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;img type:bmp&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span> 
			<span style="color: #008000;">&#125;</span>
&nbsp;
			image.<span style="color: #007788;">Save</span><span style="color: #008000;">&#40;</span>argv<span style="color: #008000;">&#91;</span><span style="color: #0000dd;">1</span><span style="color: #008000;">&#93;</span>,imageFormat<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  
		<span style="color: #008000;">&#125;</span>
&nbsp;
		<span style="color: #0000ff;">if</span> <span style="color: #008000;">&#40;</span>OpenClipboard<span style="color: #008000;">&#40;</span><span style="color: #0000ff;">NULL</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span> 
		<span style="color: #008000;">&#123;</span> 
			EmptyClipboard<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span> 
			SetClipboardData<span style="color: #008000;">&#40;</span>CF_BITMAP, image<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span> 
			CloseClipboard<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span> 
		<span style="color: #008000;">&#125;</span> 
		<span style="color: #666666;">//::PostMessage(hwnd, WM_KEYDOWN,44 , 0L); //发送 VK_PRINTSCREEN按下的键盘消息   </span>
&nbsp;
		image.<span style="color: #007788;">Detach</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>   
		<span style="color: #008080;">::</span><span style="color: #007788;">SelectObject</span><span style="color: #008000;">&#40;</span>hDCMem, hOldMap<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  
		<span style="color: #008080;">::</span><span style="color: #007788;">DeleteObject</span><span style="color: #008000;">&#40;</span>hBitMap<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  
		<span style="color: #008080;">::</span><span style="color: #007788;">DeleteDC</span><span style="color: #008000;">&#40;</span>hDCMem<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  
		<span style="color: #008080;">::</span><span style="color: #007788;">DeleteDC</span><span style="color: #008000;">&#40;</span>hDC<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  
&nbsp;
	<span style="color: #0000ff;">return</span> <span style="color: #0000dd;">0</span><span style="color: #008080;">;</span>
<span style="color: #008000;">&#125;</span></pre></div></div>

<p>&nbsp;<br />
附件下载:<a href='http://imzc.net/wp-content/uploads/2012/04/cap_src_vs2005.rar'>cap_src_vs2005</a></p>
]]></content:encoded>
			<wfw:commentRss>http://imzc.net/archives/253/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>ruby调用OLE实现word输出(支持嵌入图片)</title>
		<link>http://imzc.net/archives/238/</link>
		<comments>http://imzc.net/archives/238/#comments</comments>
		<pubDate>Sun, 01 Apr 2012 09:48:44 +0000</pubDate>
		<dc:creator>imzc</dc:creator>
				<category><![CDATA[Ruby&Testing]]></category>

		<guid isPermaLink="false">http://imzc.net/?p=238</guid>
		<description><![CDATA[由于项目的需要，要实现ruby生成word报告。而且，要求能嵌入图片。 RTF和PDF，ruby都已经有开源的 [...]]]></description>
			<content:encoded><![CDATA[<p>由于项目的需要，要实现ruby生成word报告。而且，要求能嵌入图片。<br />
RTF和PDF，ruby都已经有开源的实现了，但是在github上面找到的都是要求ruby版本在1.8.7之上，<br />
而我们的自动化框架还在1.8.6，所以，都不能使用。<br />
word OLE在哪里去搜索参数列表啊。。。貌似网上都找不到详细的。这个挺悲剧的。<br />
有知道的朋友可以PM我一下，多谢。。。<br />
嵌入图片有两种函数，后来使用了第二种：<br />
ad.Shapes.AddPicture(picture_360.to_s,false,true,left,top,width,height)<br />
sel.InlineShapes.AddPicture(picture_360.to_s,false,true,nil)<br />
经过网上搜索加以整理，最终实现了，代码如下：</p>

<div class="wp_syntax"><div class="code"><pre class="ruby" style="font-family:monospace;"><span style="color:#008000; font-style:italic;"># coding: utf-8</span>
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'win32ole'</span>  
&nbsp;
root =  <span style="color:#CC00FF; font-weight:bold;">File</span>.<span style="color:#9900CC;">expand_path</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#CC00FF; font-weight:bold;">File</span>.<span style="color:#9900CC;">dirname</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#0000FF; font-weight:bold;">__FILE__</span><span style="color:#006600; font-weight:bold;">&#41;</span> <span style="color:#006600; font-weight:bold;">&#41;</span>
pic_root = root <span style="color:#006600; font-weight:bold;">+</span> <span style="color:#996600;">&quot;/pics&quot;</span>
start = <span style="color:#CC00FF; font-weight:bold;">Time</span>.<span style="color:#9900CC;">now</span>  
filename = root<span style="color:#006600; font-weight:bold;">+</span><span style="color:#996600;">&quot;/virus_scan_reports_&quot;</span><span style="color:#006600; font-weight:bold;">+</span>start.<span style="color:#9900CC;">to_i</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">to_s</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006600; font-weight:bold;">&#41;</span><span style="color:#006600; font-weight:bold;">+</span><span style="color:#996600;">&quot;.doc&quot;</span> 
&nbsp;
<span style="color:#CC0066; font-weight:bold;">puts</span><span style="color:#006600; font-weight:bold;">&#40;</span>root<span style="color:#006600; font-weight:bold;">+</span><span style="color:#996600;">&quot;,time:&quot;</span><span style="color:#006600; font-weight:bold;">+</span>start.<span style="color:#9900CC;">to_i</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">to_s</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006600; font-weight:bold;">&#41;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
<span style="color:#9966CC; font-weight:bold;">def</span> word_report<span style="color:#006600; font-weight:bold;">&#40;</span>report_filename,pic_hash,scantitle=<span style="color:#996600;">&quot;&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
word=WIN32OLE.<span style="color:#9900CC;">new</span> <span style="color:#996600;">'word.Application'</span>
word.<span style="color:#9900CC;">visible</span>=<span style="color:#0000FF; font-weight:bold;">false</span> 
doc=word.<span style="color:#9900CC;">Documents</span>
d=doc.<span style="color:#9900CC;">add</span>
sel=word.<span style="color:#9900CC;">Selection</span>
ad=word.<span style="color:#9900CC;">ActiveDocument</span>
&nbsp;
ad.<span style="color:#9900CC;">Styles</span>.<span style="color:#9900CC;">Add</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">'Name'</span><span style="color:#006600; font-weight:bold;">=&gt;</span><span style="color:#996600;">'title'</span><span style="color:#006600; font-weight:bold;">&#41;</span>
font=ad.<span style="color:#9900CC;">Styles</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;title&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">Font</span>
font.<span style="color:#9900CC;">Size</span>=<span style="color:#006666;">20</span>
font.<span style="color:#9900CC;">Bold</span>=<span style="color:#0000FF; font-weight:bold;">true</span>
font.<span style="color:#9900CC;">Name</span>=<span style="color:#996600;">&quot;宋体&quot;</span>
&nbsp;
ad.<span style="color:#9900CC;">Styles</span>.<span style="color:#9900CC;">Add</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">'Name'</span><span style="color:#006600; font-weight:bold;">=&gt;</span><span style="color:#996600;">'content'</span><span style="color:#006600; font-weight:bold;">&#41;</span>
font=ad.<span style="color:#9900CC;">Styles</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;content&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">Font</span>
font.<span style="color:#9900CC;">Size</span>=<span style="color:#006666;">12</span>
font.<span style="color:#9900CC;">Bold</span>=<span style="color:#0000FF; font-weight:bold;">false</span>
font.<span style="color:#9900CC;">Name</span>=<span style="color:#996600;">&quot;宋体&quot;</span>
&nbsp;
sel.<span style="color:#9900CC;">Style</span>=ad.<span style="color:#9900CC;">Styles</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;title&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>  
sel.<span style="color:#9900CC;">typeText</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;杀毒报告:#{scantitle}&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span> 
&nbsp;
sel.<span style="color:#9900CC;">TypeParagraph</span>;
sel.<span style="color:#9900CC;">Style</span>=ad.<span style="color:#9900CC;">Styles</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;content&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span> 
&nbsp;
picture_360 = pic_hash<span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#ff3333; font-weight:bold;">:picture_360</span><span style="color:#006600; font-weight:bold;">&#93;</span>   
picture_macaffee = pic_hash<span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#ff3333; font-weight:bold;">:picture_macaffee</span><span style="color:#006600; font-weight:bold;">&#93;</span>  
picture_trend = pic_hash<span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#ff3333; font-weight:bold;">:picture_trend</span><span style="color:#006600; font-weight:bold;">&#93;</span>
picture_duba = pic_hash<span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#ff3333; font-weight:bold;">:picture_duba</span><span style="color:#006600; font-weight:bold;">&#93;</span> 
picture_rsing = pic_hash<span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#ff3333; font-weight:bold;">:picture_rsing</span><span style="color:#006600; font-weight:bold;">&#93;</span> 
&nbsp;
sel.<span style="color:#9900CC;">TypeText</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;360杀毒&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>;
sel.<span style="color:#9900CC;">TypeParagraph</span>;
<span style="color:#008000; font-style:italic;">#argvs:$file;msoFalse # link to file ; msoTrue # save with document ;$left, $top, $width, $height</span>
<span style="color:#008000; font-style:italic;">#ad.Shapes.AddPicture(picture_360.to_s,false,true,left,top,width,height)</span>
sel.<span style="color:#9900CC;">InlineShapes</span>.<span style="color:#9900CC;">AddPicture</span><span style="color:#006600; font-weight:bold;">&#40;</span>picture_360.<span style="color:#9900CC;">to_s</span>,<span style="color:#0000FF; font-weight:bold;">false</span>,<span style="color:#0000FF; font-weight:bold;">true</span>,<span style="color:#0000FF; font-weight:bold;">nil</span><span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
sel.<span style="color:#9900CC;">TypeParagraph</span>;
sel.<span style="color:#9900CC;">TypeText</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;MCaffee杀毒&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>;
sel.<span style="color:#9900CC;">TypeParagraph</span>; 
sel.<span style="color:#9900CC;">InlineShapes</span>.<span style="color:#9900CC;">AddPicture</span><span style="color:#006600; font-weight:bold;">&#40;</span>picture_macaffee.<span style="color:#9900CC;">to_s</span>,<span style="color:#0000FF; font-weight:bold;">false</span>,<span style="color:#0000FF; font-weight:bold;">true</span>,<span style="color:#0000FF; font-weight:bold;">nil</span><span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
sel.<span style="color:#9900CC;">TypeParagraph</span>;
sel.<span style="color:#9900CC;">TypeText</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;Trend Pc-cilin杀毒&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>;
sel.<span style="color:#9900CC;">TypeParagraph</span>; 
sel.<span style="color:#9900CC;">InlineShapes</span>.<span style="color:#9900CC;">AddPicture</span><span style="color:#006600; font-weight:bold;">&#40;</span>picture_trend.<span style="color:#9900CC;">to_s</span>,<span style="color:#0000FF; font-weight:bold;">false</span>,<span style="color:#0000FF; font-weight:bold;">true</span>,<span style="color:#0000FF; font-weight:bold;">nil</span><span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
sel.<span style="color:#9900CC;">TypeParagraph</span>;
sel.<span style="color:#9900CC;">TypeText</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;金山毒霸杀毒&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>;
sel.<span style="color:#9900CC;">TypeParagraph</span>; 
sel.<span style="color:#9900CC;">InlineShapes</span>.<span style="color:#9900CC;">AddPicture</span><span style="color:#006600; font-weight:bold;">&#40;</span>picture_duba.<span style="color:#9900CC;">to_s</span>,<span style="color:#0000FF; font-weight:bold;">false</span>,<span style="color:#0000FF; font-weight:bold;">true</span>,<span style="color:#0000FF; font-weight:bold;">nil</span><span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
sel.<span style="color:#9900CC;">TypeParagraph</span>;
sel.<span style="color:#9900CC;">TypeText</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;瑞星杀毒&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>;
sel.<span style="color:#9900CC;">TypeParagraph</span>; 
sel.<span style="color:#9900CC;">InlineShapes</span>.<span style="color:#9900CC;">AddPicture</span><span style="color:#006600; font-weight:bold;">&#40;</span>picture_rsing.<span style="color:#9900CC;">to_s</span>,<span style="color:#0000FF; font-weight:bold;">false</span>,<span style="color:#0000FF; font-weight:bold;">true</span>,<span style="color:#0000FF; font-weight:bold;">nil</span><span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
<span style="color:#008000; font-style:italic;"># word.ActiveDocument.Save </span>
word.<span style="color:#9900CC;">DefaultSaveFormat</span> 
d.<span style="color:#9900CC;">saveas</span><span style="color:#006600; font-weight:bold;">&#40;</span>report_filename<span style="color:#006600; font-weight:bold;">&#41;</span>;
<span style="color:#008000; font-style:italic;"># word.ActiveDocument.Close</span>
<span style="color:#008000; font-style:italic;"># word.Documents.close() </span>
word.<span style="color:#9900CC;">quit</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006600; font-weight:bold;">&#41;</span>    
&nbsp;
<span style="color:#9966CC; font-weight:bold;">end</span>
&nbsp;
&nbsp;
pic_hash = <span style="color:#006600; font-weight:bold;">&#123;</span><span style="color:#006600; font-weight:bold;">&#125;</span>
pic_hash<span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#ff3333; font-weight:bold;">:picture_360</span><span style="color:#006600; font-weight:bold;">&#93;</span> = pic_root<span style="color:#006600; font-weight:bold;">+</span><span style="color:#996600;">&quot;/360_2012_03_31__20_54_27.bmp&quot;</span>      
pic_hash<span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#ff3333; font-weight:bold;">:picture_macaffee</span><span style="color:#006600; font-weight:bold;">&#93;</span> = pic_root<span style="color:#006600; font-weight:bold;">+</span><span style="color:#996600;">&quot;/macaffee_2012_04_01__21_18_36.bmp&quot;</span>  
pic_hash<span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#ff3333; font-weight:bold;">:picture_trend</span><span style="color:#006600; font-weight:bold;">&#93;</span> = pic_root<span style="color:#006600; font-weight:bold;">+</span><span style="color:#996600;">&quot;/trend_pccilin_2012_03_31__20_53_20.bmp&quot;</span>
pic_hash<span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#ff3333; font-weight:bold;">:picture_duba</span><span style="color:#006600; font-weight:bold;">&#93;</span> = pic_root<span style="color:#006600; font-weight:bold;">+</span><span style="color:#996600;">&quot;/kingsoft_duba_2012_03_31__20_55_37.bmp&quot;</span>  
pic_hash<span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#ff3333; font-weight:bold;">:picture_rsing</span><span style="color:#006600; font-weight:bold;">&#93;</span> = pic_root<span style="color:#006600; font-weight:bold;">+</span><span style="color:#996600;">&quot;/rsing_2012_03_31__20_53_58.bmp&quot;</span>
&nbsp;
word_report<span style="color:#006600; font-weight:bold;">&#40;</span>filename,pic_hash,<span style="color:#996600;">&quot;att test&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span></pre></div></div>

<p>&nbsp;</p>
]]></content:encoded>
			<wfw:commentRss>http://imzc.net/archives/238/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>autoit3实现命令行调用杀毒软件</title>
		<link>http://imzc.net/archives/234/</link>
		<comments>http://imzc.net/archives/234/#comments</comments>
		<pubDate>Fri, 30 Mar 2012 04:31:53 +0000</pubDate>
		<dc:creator>imzc</dc:creator>
				<category><![CDATA[Ruby&Testing]]></category>

		<guid isPermaLink="false">http://imzc.net/?p=234</guid>
		<description><![CDATA[自动化项目需要调用杀毒软件对特定文件夹进行病毒扫描，但是大部分杀毒软件都没有提供命令行支持。因此只能从图形界面 [...]]]></description>
			<content:encoded><![CDATA[<p>自动化项目需要调用杀毒软件对特定文件夹进行病毒扫描，但是大部分杀毒软件都没有提供命令行支持。因此只能从图形界面操作搞定。<br />
sikuli可以实现截图方式点击，但是不太稳定，而且，对于趋势杀毒软件，只能选择到某个盘符，不能选择到具体的文件夹，故存在一定的弱点。<br />
考虑到杀毒软件都有提供一个右键菜单，查询注册表发现是一个shellext.dll扩展，不能通过rundll32方式调用。因此可以考虑使用autoit进行操作了。重要知识点：<br />
1.使用windows资源管理器打开特定的文件夹，且处于选中状态，explorer支持多种参数，其中select是实现本功能的参数：<br />
RunWait(@ComSpec &amp; &#8216; /c &#8216; &amp; &#8216;explorer /select,&#8217; &amp; $DirName,&#8221;, @SW_HIDE)</p>
<p> 2.有些时候对应的文件夹已经处于打开状态，且可能选中到其他文件夹，因此需要使用autoit3的函数，将所有文件夹取消选中。<br />
 而特定的文件夹再设置为selected。<br />
 3.直接通过_GUICtrlMenu_GetMenu($hWnd)函数总是失败，因此只有采取变通的手段，通过发送windows消息来获取响应的菜单句柄。<br />
 $hMenu = _SendMessage($hWnd, 0x01E1) ;0x01E1 MN_GETHMENU<br />
 4.由于autoit3的GuiMenu.au3还未提供click对应item的功能，因此只能通过发送快捷键： {DOWN}，{ENTER}来实现选择菜单。<br />
 5.右键菜单曾经打算使用发送WM_CONTEXTMENU消息获得，但是发现在某些机子上面又不行，<br />
 ;007B WM_CONTEXTMENU<br />
 ;_WinAPI_PostMessage($hWnd, 0x007B, 0, 0)<br />
 所以只得采取另外的方法：SHIFT+F10，快捷键很爽啊。。。<br />
 6._GUICtrlMenu_GetItemText($hMenu, $iItem[, $fByPos = True])函数有些时候获取不到菜单的名称（可能是程序内部处理了，如360杀毒），因此需要提供通过索引的方式点击。。。<br />
 7.autoit3编译为exe文件，需要选取“console”（默认是GUI的），以便查看程序输出情况。<br />
使用参数： scan &#8220;E:\待扫描文件&#8221; &#8220;使用|扫描|查杀&#8221;<br />
           scan &#8220;E:\待扫描文件&#8221; &#8220;使用|扫描|查杀&#8221;  15 （最后一个参数是在获取不到对应菜单时，直接点击菜单项目序号，排除空白的）<br />
 具体源码见下：</p>

<div class="wp_syntax"><div class="code"><pre class="vbnet" style="font-family:monospace;">#Include &lt;GuiListView.<span style="color: #0000FF;">au3</span>&gt; 
#include &lt;WinAPI.<span style="color: #0000FF;">au3</span>&gt;  
#include &lt;GuiMenu.<span style="color: #0000FF;">au3</span>&gt;
&nbsp;
&nbsp;
&nbsp;
;scan.<span style="color: #0000FF;">exe</span> <span style="color: #808080;">&quot;E:\att_proj\360scan&quot;</span> <span style="color: #808080;">&quot;使用 ESET NOD32 Antivirus 扫描&quot;</span>
&nbsp;
$DirName <span style="color: #008000;">=</span> <span style="color: #808080;">&quot;E:\待扫描文件&quot;</span>
$AntiVirusSoftName <span style="color: #008000;">=</span>  <span style="color: #808080;">&quot;扫描&quot;</span>
&nbsp;
$itemToClick <span style="color: #008000;">=</span> <span style="color: #008000;">-</span><span style="color: #FF0000;">1</span>
&nbsp;
<span style="color: #0600FF;">If</span> <span style="color: #FF0000;">1</span><span style="color: #008000;">=</span><span style="color: #FF0000;">1</span> <span style="color: #FF8000;">Then</span>
&nbsp;
&nbsp;
<span style="color: #0600FF;">If</span> $cmdline<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">0</span><span style="color: #000000;">&#93;</span> <span style="color: #008000;">=</span> <span style="color: #FF0000;">2</span> or $cmdline<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">0</span><span style="color: #000000;">&#93;</span> <span style="color: #008000;">=</span> <span style="color: #FF0000;">3</span> <span style="color: #FF8000;">Then</span>
    $DirName <span style="color: #008000;">=</span> $cmdline<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">1</span><span style="color: #000000;">&#93;</span>
  $AntiVirusSoftName <span style="color: #008000;">=</span> $cmdline<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">2</span><span style="color: #000000;">&#93;</span> 
  <span style="color: #0600FF;">If</span> $cmdline<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">0</span><span style="color: #000000;">&#93;</span> <span style="color: #008000;">=</span> <span style="color: #FF0000;">3</span> <span style="color: #FF8000;">Then</span> $itemToClick <span style="color: #008000;">=</span>  $cmdline<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">3</span><span style="color: #000000;">&#93;</span>
<span style="color: #FF8000;">Else</span>     
  ConsoleWrite<span style="color: #000000;">&#40;</span><span style="color: #008080; font-style: italic;">'Please use this program with two/three argvs, 目录名称 and 右键菜单.'&amp; @CRLF)</span>
  ConsoleWrite<span style="color: #000000;">&#40;</span><span style="color: #008080; font-style: italic;">'Such as programName &quot;D:\appserv&quot; &quot;使用 ESET NOD32 Antivirus 扫描&quot;.' &amp; @CRLF)</span>
  ConsoleWrite<span style="color: #000000;">&#40;</span><span style="color: #008080; font-style: italic;">'Such as programName &quot;D:\appserv&quot; &quot;使用 ESET NOD32 Antivirus 扫描&quot; itermnum(begin at zero) .' &amp; @CRLF)</span>
  <span style="color: #0600FF;">exit</span>
EndIf 
&nbsp;
<span style="color: #0600FF;">If</span> FileExists<span style="color: #000000;">&#40;</span>$DirName<span style="color: #000000;">&#41;</span><span style="color: #008000;">=</span><span style="color: #FF0000;">0</span> <span style="color: #FF8000;">Then</span>
    ConsoleWrite<span style="color: #000000;">&#40;</span><span style="color: #008080; font-style: italic;">'DirName:'&amp;$DirName&amp;' is not exists.' &amp; @CRLF)</span>
  <span style="color: #0600FF;">exit</span>
EndIf
&nbsp;
EndIf
&nbsp;
ConsoleWrite<span style="color: #000000;">&#40;</span><span style="color: #008080; font-style: italic;">'$DirName:'&amp;$DirName&amp;',$AntiVirusSoftName:'&amp;$AntiVirusSoftName &amp; @CRLF)</span>
&nbsp;
$array <span style="color: #008000;">=</span> StringSplit<span style="color: #000000;">&#40;</span>$DirName, <span style="color: #008080; font-style: italic;">'\', 1)</span>
$ItemName <span style="color: #008000;">=</span> $array<span style="color: #000000;">&#91;</span><span style="color: #0600FF;">UBound</span><span style="color: #000000;">&#40;</span>$array<span style="color: #000000;">&#41;</span><span style="color: #008000;">-</span><span style="color: #FF0000;">1</span><span style="color: #000000;">&#93;</span>
ConsoleWrite<span style="color: #000000;">&#40;</span><span style="color: #008080; font-style: italic;">'$ItemName:'&amp;$ItemName&amp; @CRLF)</span>
&nbsp;
;close all window
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
;While <span style="color: #FF0000;">1</span> ;use infinite <span style="color: #0600FF;">loop</span> since ExitLoop will <span style="color: #FF8000;">get</span> called
;   $TITLE <span style="color: #008000;">=</span> WinGetTitle<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;[CLASS:CabinetWClass]&quot;</span>,<span style="color: #808080;">&quot;&quot;</span><span style="color: #000000;">&#41;</span>
;  ConsoleWrite<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;Try to Close one control: [CLASS:CabinetWClass],title:&quot;</span><span style="color: #008000;">&amp;</span>$TITLE<span style="color: #008000;">&amp;</span> @<span style="color: #0600FF;">CRLF</span><span style="color: #000000;">&#41;</span>
;  $hanlde <span style="color: #008000;">=</span> WinGetHandle<span style="color: #000000;">&#40;</span>$TITLE<span style="color: #000000;">&#41;</span> 
 ;   $ans <span style="color: #008000;">=</span> WinClose<span style="color: #000000;">&#40;</span>$hanlde<span style="color: #000000;">&#41;</span>  
 ;   <span style="color: #0600FF;">If</span> $ans <span style="color: #008000;">=</span> <span style="color: #FF0000;">0</span> <span style="color: #FF8000;">Then</span> ExitLoop
;WEnd 
&nbsp;
RunWait<span style="color: #000000;">&#40;</span>@ComSpec <span style="color: #008000;">&amp;</span> <span style="color: #008080; font-style: italic;">' /c ' &amp; 'explorer /select,' &amp; $DirName,'', @SW_HIDE)</span>
&nbsp;
Opt<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;WinTitleMatchMode&quot;</span>, <span style="color: #FF0000;">1</span><span style="color: #000000;">&#41;</span>     ;<span style="color: #FF0000;">1</span><span style="color: #008000;">=</span>start, <span style="color: #FF0000;">2</span><span style="color: #008000;">=</span>subStr, <span style="color: #FF0000;">3</span><span style="color: #008000;">=</span>exact, <span style="color: #FF0000;">4</span><span style="color: #008000;">=</span>advanced, <span style="color: #008000;">-</span><span style="color: #FF0000;">1</span> <span style="color: #FF8000;">to</span> <span style="color: #008000;">-</span><span style="color: #FF0000;">4</span><span style="color: #008000;">=</span>Nocase
&nbsp;
WinSetState<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;[CLASS:CabinetWClass]&quot;</span>, <span style="color: #808080;">&quot;&quot;</span>, @SW_SHOW<span style="color: #000000;">&#41;</span>
;WinActivate<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;[CLASS:CabinetWClass]&quot;</span>, <span style="color: #808080;">&quot;&quot;</span><span style="color: #000000;">&#41;</span>
&nbsp;
;$hWnd <span style="color: #008000;">=</span> ControlGetHandle<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;&quot;</span>,<span style="color: #808080;">&quot;FolderView&quot;</span>,<span style="color: #808080;">&quot;[CLASS:SysListView32]&quot;</span><span style="color: #000000;">&#41;</span>
$hWnd <span style="color: #008000;">=</span> ControlGetHandle<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;&quot;</span>,<span style="color: #808080;">&quot;FolderView&quot;</span>,<span style="color: #808080;">&quot;[CLASS:SysListView32; INSTANCE:1]&quot;</span><span style="color: #000000;">&#41;</span>
&nbsp;
;$pos <span style="color: #008000;">=</span> ControlGetPos<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;&quot;</span>,<span style="color: #808080;">&quot;FolderView&quot;</span>,<span style="color: #808080;">&quot;[CLASS:SysListView32]&quot;</span><span style="color: #000000;">&#41;</span>
;MsgBox<span style="color: #000000;">&#40;</span><span style="color: #FF0000;">0</span>, <span style="color: #808080;">&quot;Window Stats:&quot;</span>, <span style="color: #808080;">&quot;POS: &quot;</span> <span style="color: #008000;">&amp;</span> $pos<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">0</span><span style="color: #000000;">&#93;</span> <span style="color: #008000;">&amp;</span> <span style="color: #808080;">&quot;,&quot;</span> <span style="color: #008000;">&amp;</span> $pos<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">1</span><span style="color: #000000;">&#93;</span> <span style="color: #008000;">&amp;</span> <span style="color: #808080;">&quot; SIZE: &quot;</span> <span style="color: #008000;">&amp;</span> $pos<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">2</span><span style="color: #000000;">&#93;</span> <span style="color: #008000;">&amp;</span> <span style="color: #808080;">&quot;,&quot;</span> <span style="color: #008000;">&amp;</span> $pos<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">3</span><span style="color: #000000;">&#93;</span> <span style="color: #000000;">&#41;</span>
&nbsp;
&nbsp;
&nbsp;
$items  <span style="color: #008000;">=</span> _GUICtrlListView_GetItemCount<span style="color: #000000;">&#40;</span>$hWnd<span style="color: #000000;">&#41;</span>
&nbsp;
&nbsp;
;ConsoleWrite<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;Item Count: &quot;</span> <span style="color: #008000;">&amp;</span> $items <span style="color: #008000;">&amp;</span> @<span style="color: #0600FF;">CRLF</span><span style="color: #000000;">&#41;</span>
&nbsp;
;ConsoleWrite<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;Item  Focused: &quot;</span> <span style="color: #008000;">&amp;</span> _GUICtrlListView_GetItemFocused<span style="color: #000000;">&#40;</span>$hWnd, <span style="color: #FF0000;">1</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>
&nbsp;
&nbsp;
<span style="color: #FF8000;">For</span> $i <span style="color: #008000;">=</span> <span style="color: #FF0000;">0</span> <span style="color: #FF8000;">To</span> $items <span style="color: #008000;">-</span><span style="color: #FF0000;">1</span>
 $ItemText <span style="color: #008000;">=</span> _GUICtrlListView_GetItemText<span style="color: #000000;">&#40;</span>$hWnd, $i<span style="color: #000000;">&#41;</span>
 ;ConsoleWrite<span style="color: #000000;">&#40;</span>$ItemText<span style="color: #008000;">&amp;</span> @<span style="color: #0600FF;">CRLF</span><span style="color: #000000;">&#41;</span>
 _GUICtrlListView_SetItemSelected<span style="color: #000000;">&#40;</span>$hWnd,$i,<span style="color: #0600FF;">False</span><span style="color: #000000;">&#41;</span>
 Sleep<span style="color: #000000;">&#40;</span><span style="color: #FF0000;">10</span><span style="color: #000000;">&#41;</span>
 <span style="color: #0600FF;">If</span> $ItemText <span style="color: #008000;">=</span> $ItemName <span style="color: #FF8000;">Then</span>
  $aRect <span style="color: #008000;">=</span> _GUICtrlListView_GetItemRect<span style="color: #000000;">&#40;</span>$hWnd,$i<span style="color: #000000;">&#41;</span>
  ConsoleWrite<span style="color: #000000;">&#40;</span>StringFormat<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;Item 2 Rectangle : [%d, %d, %d, %d]&quot;</span>, $aRect<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">0</span><span style="color: #000000;">&#93;</span>, $aRect<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">1</span><span style="color: #000000;">&#93;</span>, $aRect<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">2</span><span style="color: #000000;">&#93;</span>, $aRect<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">3</span><span style="color: #000000;">&#93;</span><span style="color: #000000;">&#41;</span><span style="color: #008000;">&amp;</span> @<span style="color: #0600FF;">CRLF</span><span style="color: #000000;">&#41;</span>
&nbsp;
  $aPos <span style="color: #008000;">=</span> _GUICtrlListView_GetItemPosition<span style="color: #000000;">&#40;</span>$hWnd, $i<span style="color: #000000;">&#41;</span>
  ConsoleWrite<span style="color: #000000;">&#40;</span>StringFormat<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;Item Position : [%d, %d]&quot;</span>, $aPos<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">0</span><span style="color: #000000;">&#93;</span>, $aPos<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">1</span><span style="color: #000000;">&#93;</span><span style="color: #000000;">&#41;</span><span style="color: #008000;">&amp;</span> @<span style="color: #0600FF;">CRLF</span><span style="color: #000000;">&#41;</span>
&nbsp;
  ;MouseMove <span style="color: #000000;">&#40;</span>$aRect<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">2</span><span style="color: #000000;">&#93;</span>, $aRect<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">3</span><span style="color: #000000;">&#93;</span><span style="color: #000000;">&#41;</span>
  ;Sleep<span style="color: #000000;">&#40;</span><span style="color: #FF0000;">2000</span><span style="color: #000000;">&#41;</span>
  ;ControlClick<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;&quot;</span>,<span style="color: #808080;">&quot;FolderView&quot;</span>,<span style="color: #808080;">&quot;[CLASS:SysListView32]&quot;</span>,<span style="color: #808080;">&quot;right&quot;</span>,<span style="color: #FF0000;">1</span>,$aPos<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">0</span><span style="color: #000000;">&#93;</span><span style="color: #008000;">+</span><span style="color: #FF0000;">20</span>,$aPos<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">1</span><span style="color: #000000;">&#93;</span><span style="color: #008000;">+</span><span style="color: #FF0000;">20</span><span style="color: #000000;">&#41;</span>
&nbsp;
    $centerX <span style="color: #008000;">=</span> <span style="color: #000000;">&#40;</span>$aRect<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">0</span><span style="color: #000000;">&#93;</span> <span style="color: #008000;">+</span> $aRect<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">2</span><span style="color: #000000;">&#93;</span><span style="color: #000000;">&#41;</span><span style="color: #008000;">/</span><span style="color: #FF0000;">2</span>
  $centerY <span style="color: #008000;">=</span> <span style="color: #000000;">&#40;</span>$aRect<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">1</span><span style="color: #000000;">&#93;</span> <span style="color: #008000;">+</span> $aRect<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">3</span><span style="color: #000000;">&#93;</span><span style="color: #000000;">&#41;</span><span style="color: #008000;">/</span><span style="color: #FF0000;">2</span>
  $aPos <span style="color: #008000;">=</span> _GUICtrlListView_GetItemPosition<span style="color: #000000;">&#40;</span>$hWnd, $i<span style="color: #000000;">&#41;</span>
  ConsoleWrite<span style="color: #000000;">&#40;</span>StringFormat<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;Item Position : [%d, %d]&quot;</span>, $aPos<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">0</span><span style="color: #000000;">&#93;</span>, $aPos<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">1</span><span style="color: #000000;">&#93;</span><span style="color: #000000;">&#41;</span><span style="color: #008000;">&amp;</span> @<span style="color: #0600FF;">CRLF</span><span style="color: #000000;">&#41;</span>
&nbsp;
  _GUICtrlListView_SetItemSelected<span style="color: #000000;">&#40;</span>$hWnd,$i<span style="color: #000000;">&#41;</span>
&nbsp;
  ;MouseMove <span style="color: #000000;">&#40;</span>$aRect<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">2</span><span style="color: #000000;">&#93;</span>, $aRect<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">3</span><span style="color: #000000;">&#93;</span><span style="color: #000000;">&#41;</span>
  ;Sleep<span style="color: #000000;">&#40;</span><span style="color: #FF0000;">2000</span><span style="color: #000000;">&#41;</span>
  ;ControlClick<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;&quot;</span>,<span style="color: #808080;">&quot;FolderView&quot;</span>,<span style="color: #808080;">&quot;[CLASS:SysListView32]&quot;</span>,<span style="color: #808080;">&quot;right&quot;</span>,<span style="color: #FF0000;">1</span>,$centerX,$centerY<span style="color: #000000;">&#41;</span>
&nbsp;
  ;ExitLoop 
 EndIf
&nbsp;
<span style="color: #FF8000;">Next</span>
&nbsp;
&nbsp;
&nbsp;
;MsgBox<span style="color: #000000;">&#40;</span><span style="color: #FF0000;">0</span>, <span style="color: #808080;">&quot;HWnd:t,c&quot;</span>, $hWndf <span style="color: #008000;">&amp;</span><span style="color: #808080;">&quot;,&quot;</span><span style="color: #008000;">&amp;</span>$hWnd<span style="color: #000000;">&#41;</span>
;007B WM_CONTEXTMENU
;0x001611DA
;_WinAPI_PostMessage<span style="color: #000000;">&#40;</span>$hWnd, 0x007B, 0x001611da,0x00d30342<span style="color: #000000;">&#41;</span>
&nbsp;
;_WinAPI_PostMessage<span style="color: #000000;">&#40;</span>$hWnd, 0x007B, <span style="color: #FF0000;">0</span>, <span style="color: #FF0000;">0</span><span style="color: #000000;">&#41;</span>;<span style="color: #FF0000;">100</span>,<span style="color: #FF0000;">100</span><span style="color: #000000;">&#41;</span>
&nbsp;
Opt<span style="color: #000000;">&#40;</span><span style="color: #008080; font-style: italic;">'WinSearchChildren', 1)</span>
&nbsp;
HotKeySet<span style="color: #000000;">&#40;</span><span style="color: #008080; font-style: italic;">'{ESC}', '_EXIT')</span>
OnAutoItExitRegister<span style="color: #000000;">&#40;</span><span style="color: #008080; font-style: italic;">'OnAutoItExit')</span>
&nbsp;
Global <span style="color: #0600FF;">Const</span> $MN_GETHMENU <span style="color: #008000;">=</span> 0x01E1
Global <span style="color: #0600FF;">Const</span> $EVENT_SYSTEM_MENUPOPUPSTART <span style="color: #008000;">=</span> 0x0006
Global <span style="color: #0600FF;">Const</span> $EVENT_SYSTEM_MENUPOPUPEND <span style="color: #008000;">=</span> 0x0007  
Global $hFunc, $pFunc
Global $hWinHook
&nbsp;
$hFunc <span style="color: #008000;">=</span> DllCallbackRegister<span style="color: #000000;">&#40;</span><span style="color: #008080; font-style: italic;">'_WinEventProc', 'none', 'ptr;uint;hwnd;int;int;uint;uint')</span>
$pFunc <span style="color: #008000;">=</span> DllCallbackGetPtr<span style="color: #000000;">&#40;</span>$hFunc<span style="color: #000000;">&#41;</span>
$hWinHook <span style="color: #008000;">=</span> _SetWinEventHook<span style="color: #000000;">&#40;</span>0x00000001, 0x7FFFFFFF, <span style="color: #FF0000;">0</span>, $pFunc, <span style="color: #FF0000;">0</span>, <span style="color: #FF0000;">0</span>,<span style="color: #804040;">BitOR</span><span style="color: #000000;">&#40;</span>0x0002, 0x0000<span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>
&nbsp;
&nbsp;
 Send<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;+{F10}&quot;</span><span style="color: #000000;">&#41;</span> ;弹出右键菜单
&nbsp;
&nbsp;
&nbsp;
<span style="color: #0600FF;">While</span> <span style="color: #FF0000;">1</span>
        Sleep<span style="color: #000000;">&#40;</span><span style="color: #FF0000;">20</span><span style="color: #000000;">&#41;</span>
<span style="color: #0600FF;">WEnd</span>
&nbsp;
<span style="color: #FF8000;">Func</span> _EXIT<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>
        <span style="color: #0600FF;">Exit</span>
EndFunc   ;<span style="color: #008000;">==</span>&gt;_EXIT
&nbsp;
<span style="color: #FF8000;">Func</span> OnAutoItExit<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>
        _UnhookWinEvent<span style="color: #000000;">&#40;</span>$hWinHook<span style="color: #000000;">&#41;</span>
        DllCallbackFree<span style="color: #000000;">&#40;</span>$hFunc<span style="color: #000000;">&#41;</span>
EndFunc   ;<span style="color: #008000;">==</span>&gt;OnAutoItExit
&nbsp;
<span style="color: #FF8000;">Func</span> _WinEventProc<span style="color: #000000;">&#40;</span>$hHook, $iEvent, $hWnd, $iObjectID, $iChildID, $iEventThread, $imsEventTime<span style="color: #000000;">&#41;</span>
        Local $hMenu
&nbsp;
      <span style="color: #0600FF;">If</span> $iEvent <span style="color: #008000;">=</span> $EVENT_SYSTEM_MENUPOPUPSTART  <span style="color: #FF8000;">Then</span>
                $hMenu <span style="color: #008000;">=</span> _SendMessage<span style="color: #000000;">&#40;</span>$hWnd, 0x01E1<span style="color: #000000;">&#41;</span> ;0x01E1 MN_GETHMENU 
                <span style="color: #0600FF;">If</span> _GUICtrlMenu_IsMenu<span style="color: #000000;">&#40;</span>$hMenu<span style="color: #000000;">&#41;</span> <span style="color: #FF8000;">Then</span>
&nbsp;
            <span style="color: #0600FF;">If</span> $itemToClick &lt;&gt; <span style="color: #008000;">-</span><span style="color: #FF0000;">1</span> <span style="color: #FF8000;">Then</span>
&nbsp;
              ConsoleWrite<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;Click menu item direct.&quot;</span><span style="color: #008000;">&amp;</span> @<span style="color: #0600FF;">CRLF</span><span style="color: #000000;">&#41;</span>; 
               <span style="color: #FF8000;">For</span> $i <span style="color: #008000;">=</span> <span style="color: #FF0000;">0</span> <span style="color: #FF8000;">To</span> _GUICtrlMenu_GetItemCount<span style="color: #000000;">&#40;</span>$hMenu<span style="color: #000000;">&#41;</span> <span style="color: #008000;">-</span> <span style="color: #FF0000;">1</span>
                Send <span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;{DOWN}&quot;</span><span style="color: #000000;">&#41;</span> 
                <span style="color: #0600FF;">If</span> $itemToClick <span style="color: #008000;">=</span> $i <span style="color: #FF8000;">Then</span>
                  ConsoleWrite<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;Click menu item :&quot;</span> <span style="color: #008000;">&amp;</span>$itemToClick<span style="color: #008000;">&amp;</span> @<span style="color: #0600FF;">CRLF</span><span style="color: #000000;">&#41;</span>;  
                  Sleep<span style="color: #000000;">&#40;</span><span style="color: #FF0000;">1000</span><span style="color: #000000;">&#41;</span>
                  Send <span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;{ENTER}&quot;</span><span style="color: #000000;">&#41;</span> 
                  ExitLoop
                  EndIf
&nbsp;
              <span style="color: #FF8000;">Next</span> 
              <span style="color: #0600FF;">Exit</span><span style="color: #000000;">&#40;</span><span style="color: #FF0000;">0</span><span style="color: #000000;">&#41;</span>
            <span style="color: #FF8000;">Else</span> 
              $i<span style="color: #008000;">=</span><span style="color: #FF0000;">0</span>
              <span style="color: #FF8000;">For</span> $i <span style="color: #008000;">=</span> <span style="color: #FF0000;">0</span> <span style="color: #FF8000;">To</span> _GUICtrlMenu_GetItemCount<span style="color: #000000;">&#40;</span>$hMenu<span style="color: #000000;">&#41;</span> <span style="color: #008000;">-</span> <span style="color: #FF0000;">1</span>
&nbsp;
                  Sleep<span style="color: #000000;">&#40;</span><span style="color: #FF0000;">10</span><span style="color: #000000;">&#41;</span>  
                  Local $sItemText <span style="color: #008000;">=</span> _GUICtrlMenu_GetItemText<span style="color: #000000;">&#40;</span>$hMenu, $i<span style="color: #000000;">&#41;</span>
&nbsp;
                  ConsoleWrite<span style="color: #000000;">&#40;</span>$sItemText<span style="color: #008000;">&amp;</span><span style="color: #808080;">&quot;,item index:&quot;</span><span style="color: #008000;">&amp;</span>$i <span style="color: #008000;">&amp;</span> @<span style="color: #0600FF;">CRLF</span><span style="color: #000000;">&#41;</span>; 
&nbsp;
                  <span style="color: #0600FF;">If</span> $sItemText <span style="color: #008000;">=</span> <span style="color: #008080; font-style: italic;">'' Then ContinueLoop    </span>
&nbsp;
                  Send <span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;{DOWN}&quot;</span><span style="color: #000000;">&#41;</span>
                  ;If StringInStr<span style="color: #000000;">&#40;</span>$sItemText,$AntiVirusSoftName<span style="color: #000000;">&#41;</span> &lt;&gt; <span style="color: #FF0000;">0</span> <span style="color: #FF8000;">Then</span>
                  <span style="color: #0600FF;">If</span> StringRegExp <span style="color: #000000;">&#40;</span>$sItemText,$AntiVirusSoftName,<span style="color: #FF0000;">0</span><span style="color: #000000;">&#41;</span> <span style="color: #008000;">=</span><span style="color: #FF0000;">1</span> <span style="color: #FF8000;">Then</span>
                    ConsoleWrite<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;StringRegExp match,item index:&quot;</span><span style="color: #008000;">&amp;</span>$i <span style="color: #008000;">&amp;</span> @<span style="color: #0600FF;">CRLF</span><span style="color: #000000;">&#41;</span>; 
                    ;MsgBox<span style="color: #000000;">&#40;</span><span style="color: #FF0000;">0</span>, <span style="color: #808080;">&quot;HWnd&quot;</span>, <span style="color: #808080;">&quot;nod32&quot;</span><span style="color: #000000;">&#41;</span>
                    ;$subviewid <span style="color: #008000;">=</span> _GUICtrlMenu_GetItemID<span style="color: #000000;">&#40;</span>$hMenu, $i<span style="color: #000000;">&#41;</span>
                    ;_GUICtrlMenu_SetItemState<span style="color: #000000;">&#40;</span>$hMenu, $i, $MFS_CHECKED,<span style="color: #0600FF;">True</span><span style="color: #000000;">&#41;</span>
                    ;_GUICtrlMenu_SetItemDisabled<span style="color: #000000;">&#40;</span>$hMenu, $i<span style="color: #000000;">&#41;</span>
                    ;Send <span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;{ENTER}&quot;</span><span style="color: #000000;">&#41;</span> 
                    Sleep<span style="color: #000000;">&#40;</span><span style="color: #FF0000;">1000</span><span style="color: #000000;">&#41;</span>
                    Send <span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;{ENTER}&quot;</span><span style="color: #000000;">&#41;</span>
                    ;ControlClick<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;&quot;</span>, <span style="color: #808080;">&quot;&quot;</span>,$subviewid ,<span style="color: #808080;">&quot;left&quot;</span><span style="color: #000000;">&#41;</span> 
                    ExitLoop
                  EndIf
&nbsp;
              <span style="color: #FF8000;">Next</span> 
               <span style="color: #0600FF;">If</span> $i <span style="color: #008000;">=</span> <span style="color: #000000;">&#40;</span>_GUICtrlMenu_GetItemCount<span style="color: #000000;">&#40;</span>$hMenu<span style="color: #000000;">&#41;</span> <span style="color: #008000;">-</span> <span style="color: #FF0000;">1</span><span style="color: #000000;">&#41;</span> <span style="color: #FF8000;">Then</span> ConsoleWrite<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;Not found,then click the first null menu.&quot;</span> <span style="color: #008000;">&amp;</span> @<span style="color: #0600FF;">CRLF</span><span style="color: #000000;">&#41;</span> 
            EndIf
          <span style="color: #0600FF;">Exit</span><span style="color: #000000;">&#40;</span><span style="color: #FF0000;">0</span><span style="color: #000000;">&#41;</span>
          EndIf
&nbsp;
                ConsoleWrite<span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;Not Menu hwnd.&quot;</span>@<span style="color: #0600FF;">CRLF</span><span style="color: #000000;">&#41;</span>
      EndIf
&nbsp;
&nbsp;
&nbsp;
&nbsp;
EndFunc   ;<span style="color: #008000;">==</span>&gt;_WinEventProc
&nbsp;
<span style="color: #FF8000;">Func</span> _SetWinEventHook<span style="color: #000000;">&#40;</span>$ieventMin, $ieventMax, $hMod, $pCallback, $iProcID, $iThreadID, $iFlags<span style="color: #000000;">&#41;</span>
        Local $aRet
&nbsp;
        $aRet <span style="color: #008000;">=</span> DllCall<span style="color: #000000;">&#40;</span><span style="color: #008080; font-style: italic;">'user32.dll', 'ptr', 'SetWinEventHook', 'uint', $ieventMin, 'uint', $ieventMax, _</span>
                        <span style="color: #008080; font-style: italic;">'hwnd', $hMod, 'ptr', $pCallback, 'dword', $iProcID, 'dword', $iThreadID, 'uint', $iFlags)</span>
&nbsp;
        <span style="color: #0600FF;">If</span> @<span style="color: #FF8000;">error</span> Or $aRet<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">0</span><span style="color: #000000;">&#93;</span> <span style="color: #008000;">=</span> <span style="color: #FF0000;">0</span> <span style="color: #FF8000;">Then</span> <span style="color: #FF8000;">Return</span> SetError<span style="color: #000000;">&#40;</span><span style="color: #FF0000;">1</span>, <span style="color: #FF0000;">0</span>, <span style="color: #FF0000;">0</span><span style="color: #000000;">&#41;</span>
        <span style="color: #FF8000;">Return</span> $aRet<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">0</span><span style="color: #000000;">&#93;</span>
EndFunc   ;<span style="color: #008000;">==</span>&gt;_SetWinEventHook
&nbsp;
<span style="color: #FF8000;">Func</span> _UnhookWinEvent<span style="color: #000000;">&#40;</span>$hWinEventHook<span style="color: #000000;">&#41;</span>
        Local $aRet
&nbsp;
        $aRet <span style="color: #008000;">=</span> DllCall<span style="color: #000000;">&#40;</span><span style="color: #008080; font-style: italic;">'user32.dll', 'int', 'UnhookWinEvent', 'ptr', $hWinEventHook)</span>
        <span style="color: #0600FF;">If</span> @<span style="color: #FF8000;">error</span> Or $aRet<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">0</span><span style="color: #000000;">&#93;</span> <span style="color: #008000;">=</span> <span style="color: #FF0000;">0</span> <span style="color: #FF8000;">Then</span> <span style="color: #FF8000;">Return</span> SetError<span style="color: #000000;">&#40;</span><span style="color: #FF0000;">1</span>, <span style="color: #FF0000;">0</span>, <span style="color: #FF0000;">0</span><span style="color: #000000;">&#41;</span>
        <span style="color: #FF8000;">Return</span> $aRet<span style="color: #000000;">&#91;</span><span style="color: #FF0000;">0</span><span style="color: #000000;">&#93;</span>
EndFunc   ;<span style="color: #008000;">==</span>&gt;_UnhookWinEvent</pre></div></div>

<p>附件下载：<a href='http://imzc.net/wp-content/uploads/2012/03/scan_menu.rar'>scan_menu</a></p>
]]></content:encoded>
			<wfw:commentRss>http://imzc.net/archives/234/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Ruby多线程与同时使用autoit和watir处理popup弹框时的关系</title>
		<link>http://imzc.net/archives/231/</link>
		<comments>http://imzc.net/archives/231/#comments</comments>
		<pubDate>Mon, 26 Mar 2012 10:02:02 +0000</pubDate>
		<dc:creator>imzc</dc:creator>
				<category><![CDATA[Ruby&Testing]]></category>

		<guid isPermaLink="false">http://imzc.net/?p=231</guid>
		<description><![CDATA[首先强调两个东西： 1.Ruby为用户线程，当任何一个线程被阻塞了，则其他所有的都会被阻塞。 2.watir在 [...]]]></description>
			<content:encoded><![CDATA[<p>首先强调两个东西：<br />
1.Ruby为用户线程，当任何一个线程被阻塞了，则其他所有的都会被阻塞。<br />
2.watir在遇到一个弹出框时（如IE6的证书错误警告框），当前程序就被阻塞了。<br />
因此，在使用watir时，遇到弹出框后，使用autoit ole处理时，就必须注意处理弹出框的先后顺序。<br />
实例： IE6,7,8在访问证书有问题的https网站时，弹出框的处理。</p>

<div class="wp_syntax"><div class="code"><pre class="ruby" style="font-family:monospace;"><span style="color:#008000; font-style:italic;">#coding: utf-8</span>
<span style="color:#008000; font-style:italic;">#popupclicker.rb</span>
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">&quot;win32ole&quot;</span>   
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">&quot;win32/registry&quot;</span> 
&nbsp;
<span style="color:#9966CC; font-weight:bold;">def</span> get_ie_version
  wsh = WIN32OLE.<span style="color:#9900CC;">new</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;WScript.Shell&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
  value = wsh.<span style="color:#9900CC;">RegRead</span> <span style="color:#996600;">&quot;HKEY_LOCAL_MACHINE<span style="color:#000099;">\\</span>SOFTWARE<span style="color:#000099;">\\</span>Microsoft<span style="color:#000099;">\\</span>Internet Explorer<span style="color:#000099;">\\</span>version&quot;</span> 
  <span style="color:#008000; font-style:italic;">#wsh.RegWrite &quot;HKCR\foofile\shell\open\command\&quot;, &quot;REG_SZ&quot;, &quot;&quot;C:\...&quot; &quot;%1&quot;&quot;</span>
  <span style="color:#0000FF; font-weight:bold;">return</span>  value<span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#006666;">0</span><span style="color:#006600; font-weight:bold;">&#93;</span>.<span style="color:#9900CC;">chr</span> 
<span style="color:#9966CC; font-weight:bold;">end</span>
&nbsp;
autoit=WIN32OLE.<span style="color:#9900CC;">new</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;AutoItX3.Control&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>; 
autoit.<span style="color:#9900CC;">AutoItSetOption</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;WinTitleMatchMode&quot;</span>, <span style="color:#006666;">2</span><span style="color:#006600; font-weight:bold;">&#41;</span> 
WIN32OLE.<span style="color:#9900CC;">codepage</span> = <span style="color:#6666ff; font-weight:bold;">WIN32OLE::CP_UTF8</span>
<span style="color:#008000; font-style:italic;">#1=start, 2=subStr, 3=exact, 4=advanced, -1 to -4=Nocase</span>
global_title = <span style="color:#996600;">&quot;Internet Explorer&quot;</span>
<span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;in process_cert_for_ie&quot;</span>
<span style="color:#9966CC; font-weight:bold;">if</span> get_ie_version == <span style="color:#996600;">&quot;6&quot;</span> 
  <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;ie6&quot;</span>
  ie6title = <span style="color:#996600;">&quot;安全警报&quot;</span> 
&nbsp;
  global_title = ie6title
  waitresult=autoit.<span style="color:#9900CC;">WinWait</span><span style="color:#006600; font-weight:bold;">&#40;</span>global_title, <span style="color:#996600;">&quot;&quot;</span>, <span style="color:#006666;">60</span><span style="color:#006600; font-weight:bold;">&#41;</span> 
&nbsp;
  <span style="color:#9966CC; font-weight:bold;">if</span> waitresult == <span style="color:#006666;">1</span>
   autoit.<span style="color:#9900CC;">WinActivate</span><span style="color:#006600; font-weight:bold;">&#40;</span>global_title<span style="color:#006600; font-weight:bold;">&#41;</span> 
   <span style="color:#008000; font-style:italic;"># autoit.ControlClick(global_title,&quot;&quot;,&quot;[CLASS:#32770]&quot;)</span>
   <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;find ok&quot;</span>
   <span style="color:#CC0066; font-weight:bold;">sleep</span> <span style="color:#006666;">0.2</span>
   autoit.<span style="color:#9900CC;">Send</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;Y&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
   <span style="color:#CC0066; font-weight:bold;">sleep</span> <span style="color:#006666;">0.1</span>
   autoit.<span style="color:#9900CC;">Send</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;Y&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span> <span style="color:#9966CC; font-weight:bold;">if</span> autoit.<span style="color:#9900CC;">WinWait</span><span style="color:#006600; font-weight:bold;">&#40;</span>global_title, <span style="color:#996600;">&quot;&quot;</span>, <span style="color:#006666;">1</span><span style="color:#006600; font-weight:bold;">&#41;</span> == <span style="color:#006666;">1</span> 
   autoit.<span style="color:#9900CC;">WinSetState</span><span style="color:#006600; font-weight:bold;">&#40;</span>global_title, <span style="color:#996600;">&quot;&quot;</span>, <span style="color:#006666;">3</span><span style="color:#006600; font-weight:bold;">&#41;</span> <span style="color:#008000; font-style:italic;">#@SW_MAXIMIZE  3</span>
  <span style="color:#9966CC; font-weight:bold;">end</span>
&nbsp;
 <span style="color:#9966CC; font-weight:bold;">else</span>
 <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;ie 7 8&quot;</span> 
  waitresult=autoit.<span style="color:#9900CC;">WinWait</span><span style="color:#006600; font-weight:bold;">&#40;</span>global_title, <span style="color:#996600;">&quot;&quot;</span>, <span style="color:#006666;">60</span><span style="color:#006600; font-weight:bold;">&#41;</span> 
  <span style="color:#CC0066; font-weight:bold;">sleep</span> <span style="color:#006666;">1</span>;
  <span style="color:#9966CC; font-weight:bold;">if</span> waitresult == <span style="color:#006666;">1</span>
   autoit.<span style="color:#9900CC;">WinActivate</span><span style="color:#006600; font-weight:bold;">&#40;</span>global_title<span style="color:#006600; font-weight:bold;">&#41;</span>
   <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;find ok&quot;</span> 
   <span style="color:#008000; font-style:italic;">#include(&quot;IE.au3&quot;)</span>
   <span style="color:#008000; font-style:italic;"># _IELinkClickByText ( 对象变量, &quot;链接文字&quot; [, 索引 = 0], 等待 = 1]] )</span>
&nbsp;
   autoit.<span style="color:#9900CC;">WinSetState</span><span style="color:#006600; font-weight:bold;">&#40;</span>global_title, <span style="color:#996600;">&quot;&quot;</span>, <span style="color:#006666;">3</span><span style="color:#006600; font-weight:bold;">&#41;</span> <span style="color:#008000; font-style:italic;">#@SW_MAXIMIZE  3</span>
   autoit.<span style="color:#9900CC;">ControlClick</span><span style="color:#006600; font-weight:bold;">&#40;</span>global_title,<span style="color:#996600;">&quot;&quot;</span>,<span style="color:#996600;">&quot;[CLASS:Internet Explorer_Server; INSTANCE:1]&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
   <span style="color:#CC0066; font-weight:bold;">sleep</span> <span style="color:#006666;">1</span>
   autoit.<span style="color:#9900CC;">Send</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;{TAB}&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
   <span style="color:#CC0066; font-weight:bold;">sleep</span> <span style="color:#006666;">1</span>
   autoit.<span style="color:#9900CC;">Send</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;{TAB}&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
   <span style="color:#CC0066; font-weight:bold;">sleep</span> <span style="color:#006666;">1</span>
   autoit.<span style="color:#9900CC;">Send</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;{ENTER}&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span> 
  <span style="color:#9966CC; font-weight:bold;">end</span>
<span style="color:#9966CC; font-weight:bold;">end</span></pre></div></div>

<p>&nbsp;</p>

<div class="wp_syntax"><div class="code"><pre class="ruby" style="font-family:monospace;"><span style="color:#008000; font-style:italic;">#coding: utf-8</span>
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'rubygems'</span>
gem <span style="color:#996600;">'watir'</span>,<span style="color:#996600;">'1.8.1'</span>
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'win32ole'</span>;  
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'win32/registry'</span>
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'watir'</span>
&nbsp;
&nbsp;
&nbsp;
<span style="color:#9966CC; font-weight:bold;">def</span> process_cert_for_ie 
<span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;process_cert_for_ie system:&quot;</span>
file=<span style="color:#CC00FF; font-weight:bold;">File</span>.<span style="color:#9900CC;">expand_path</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#CC00FF; font-weight:bold;">File</span>.<span style="color:#9900CC;">join</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#CC00FF; font-weight:bold;">File</span>.<span style="color:#9900CC;">dirname</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#0000FF; font-weight:bold;">__FILE__</span><span style="color:#006600; font-weight:bold;">&#41;</span>,<span style="color:#996600;">&quot;popupclicker.rb&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
<span style="color:#9966CC; font-weight:bold;">begin</span>
          thread_id = <span style="color:#CC00FF; font-weight:bold;">Thread</span>.<span style="color:#9900CC;">new</span> <span style="color:#9966CC; font-weight:bold;">do</span> 
            <span style="color:#CC0066; font-weight:bold;">system</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;ruby -Ku #{file}&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span> 
           <span style="color:#9966CC; font-weight:bold;">end</span>
          thread_id.<span style="color:#9900CC;">join</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006666;">5</span><span style="color:#006600; font-weight:bold;">&#41;</span>
<span style="color:#9966CC; font-weight:bold;">rescue</span>
          <span style="color:#CC0066; font-weight:bold;">raise</span>  <span style="color:#CC00FF; font-weight:bold;">Exception</span>, <span style="color:#996600;">&quot;Problem confirm&quot;</span>
 <span style="color:#9966CC; font-weight:bold;">end</span>
&nbsp;
&nbsp;
<span style="color:#9966CC; font-weight:bold;">end</span>
&nbsp;
webui_url = <span style="color:#996600;">&quot;https://libzc.com&quot;</span>
ie = <span style="color:#6666ff; font-weight:bold;">Watir::Browser</span>.<span style="color:#9900CC;">new</span> 
ie.<span style="color:#9900CC;">bring_to_front</span> 
ie.<span style="color:#9900CC;">maximize</span>
process_cert_for_ie
ie.<span style="color:#9900CC;">goto</span><span style="color:#006600; font-weight:bold;">&#40;</span>webui_url<span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
<span style="color:#008000; font-style:italic;">#when comfirmed cert error alert ,it wastes time to load web page completely</span>
<span style="color:#006666;">10</span>.<span style="color:#9900CC;">times</span> <span style="color:#9966CC; font-weight:bold;">do</span>
<span style="color:#008000; font-style:italic;"># ie = Watir::IE.attach(:url,webui_url) </span>
 <span style="color:#9966CC; font-weight:bold;">break</span> <span style="color:#9966CC; font-weight:bold;">if</span> ie.<span style="color:#9900CC;">link</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:text</span>,<span style="color:#006600; font-weight:bold;">/</span>Ruby\<span style="color:#006600; font-weight:bold;">&amp;</span>Testing<span style="color:#006600; font-weight:bold;">/</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">exists</span>?
 <span style="color:#CC0066; font-weight:bold;">sleep</span> <span style="color:#006666;">5</span>
 <span style="color:#9966CC; font-weight:bold;">end</span>
 ie.<span style="color:#9900CC;">link</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:text</span>,<span style="color:#006600; font-weight:bold;">/</span>Ruby\<span style="color:#006600; font-weight:bold;">&amp;</span>Testing<span style="color:#006600; font-weight:bold;">/</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">click</span></pre></div></div>


<div class="wp_syntax"><div class="code"><pre class="ruby" style="font-family:monospace;"><span style="color:#008000; font-style:italic;">#popupclicker.rb Optimization</span>
  waitresult=<span style="color:#006666;">0</span>
  <span style="color:#006666;">10</span>.<span style="color:#9900CC;">times</span> <span style="color:#9966CC; font-weight:bold;">do</span>
 <span style="color:#008000; font-style:italic;"># waitresult=autoit.WinWait(global_title, &quot;&quot;, 60) </span>
  waitresult=autoit.<span style="color:#9900CC;">WinExists</span><span style="color:#006600; font-weight:bold;">&#40;</span>global_title<span style="color:#006600; font-weight:bold;">&#41;</span>
  <span style="color:#9966CC; font-weight:bold;">break</span> <span style="color:#9966CC; font-weight:bold;">if</span> waitresult==<span style="color:#006666;">1</span> 
  <span style="color:#CC0066; font-weight:bold;">sleep</span> <span style="color:#006666;">5</span>
  <span style="color:#008000; font-style:italic;">#Recommended to use WinExists to prevent blocked.</span>
  <span style="color:#9966CC; font-weight:bold;">end</span></pre></div></div>

]]></content:encoded>
			<wfw:commentRss>http://imzc.net/archives/231/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Ruby使用C/C++扩展(包括windows和linux)</title>
		<link>http://imzc.net/archives/229/</link>
		<comments>http://imzc.net/archives/229/#comments</comments>
		<pubDate>Sat, 24 Mar 2012 03:00:49 +0000</pubDate>
		<dc:creator>imzc</dc:creator>
				<category><![CDATA[Ruby&Testing]]></category>

		<guid isPermaLink="false">http://imzc.net/?p=229</guid>
		<description><![CDATA[Ruby使用C/C++扩展，可以让ruby变得很强大。 本文根据http://raylinn.iteye.co [...]]]></description>
			<content:encoded><![CDATA[<p>Ruby使用C/C++扩展，可以让ruby变得很强大。<br />
本文根据<a href="http://raylinn.iteye.com/blog/629329" target="_blank">http://raylinn.iteye.com/blog/629329</a>学习而来。<br />
先说说流程，ruby C/C++扩展，先由mkmf生成Makefile,之后再用make(linux),nmake(windows vc++)生成动态链接库。<br />
放到ruby对应目录后，直接require即可。<br />
步骤：<br />
1.编写C++文件（建议C/C++都用.cpp吧）<br />
HelloTest.cpp</p>

<div class="wp_syntax"><div class="code"><pre class="cpp" style="font-family:monospace;"><span style="color: #339900;">#include&lt;stdio.h&gt;   </span>
<span style="color: #339900;">#include&lt;ruby.h&gt;   </span>
&nbsp;
<span style="color: #0000ff;">class</span> TestClass  
<span style="color: #008000;">&#123;</span>  
<span style="color: #0000ff;">public</span><span style="color: #008080;">:</span>  
    TestClass<span style="color: #008000;">&#40;</span><span style="color: #0000ff;">void</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#123;</span><span style="color: #008000;">&#125;</span><span style="color: #008080;">;</span>  
    ~TestClass<span style="color: #008000;">&#40;</span><span style="color: #0000ff;">void</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#123;</span><span style="color: #008000;">&#125;</span><span style="color: #008080;">;</span>  
&nbsp;
    <span style="color: #0000ff;">void</span> SayHello<span style="color: #008000;">&#40;</span><span style="color: #0000ff;">char</span><span style="color: #000040;">*</span> msg<span style="color: #008000;">&#41;</span>  
    <span style="color: #008000;">&#123;</span>  
               <span style="color: #0000dd;">printf</span><span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;Ruby C/C++ extention Example cdlz.<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  
               <span style="color: #0000dd;">printf</span><span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;Your Name is: %s<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span>,msg<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  
    <span style="color: #008000;">&#125;</span>  
<span style="color: #008000;">&#125;</span><span style="color: #008080;">;</span>  
&nbsp;
<span style="color: #666666;">//VALUE self这个是不变的。指向自己。 第二个： VALUE name则是我们这个函数需要的参数。   </span>
VALUE method_sayhello<span style="color: #008000;">&#40;</span>VALUE self,VALUE name<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#123;</span>  
    <span style="color: #0000ff;">long</span> length<span style="color: #000080;">=</span><span style="color: #0000dd;">0</span><span style="color: #008080;">;</span>  
    <span style="color: #0000ff;">char</span><span style="color: #000040;">*</span> yourname <span style="color: #000080;">=</span> rb_str2cstr<span style="color: #008000;">&#40;</span>name, <span style="color: #000040;">&amp;</span>amp<span style="color: #008080;">;</span>length<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  <span style="color: #666666;">//rb_str2cstr，转换到C语言的字符串</span>
    TestClass<span style="color: #000040;">*</span> test<span style="color: #000080;">=</span><span style="color: #0000dd;">new</span> TestClass<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  
    test<span style="color: #000040;">-</span><span style="color: #000040;">&amp;</span>gt<span style="color: #008080;">;</span>SayHello<span style="color: #008000;">&#40;</span>yourname<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  
    <span style="color: #0000dd;">delete</span> test<span style="color: #008080;">;</span>  
	<span style="color: #0000ff;">return</span> rb_str_new2<span style="color: #008000;">&#40;</span>yourname<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span> <span style="color: #666666;">//rb_str_new2，由C语言的字符串转换为Ruby的String。</span>
<span style="color: #008000;">&#125;</span><span style="color: #008080;">;</span>  
&nbsp;
VALUE method_cfunction<span style="color: #008000;">&#40;</span>VALUE self, VALUE va, VALUE vb<span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
	<span style="color: #0000ff;">int</span> a <span style="color: #000080;">=</span> NUM2INT<span style="color: #008000;">&#40;</span>va<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
	<span style="color: #0000ff;">int</span> b <span style="color: #000080;">=</span> NUM2INT<span style="color: #008000;">&#40;</span>vb<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
&nbsp;
	<span style="color: #0000ff;">return</span> INT2NUM<span style="color: #008000;">&#40;</span>a<span style="color: #000040;">+</span>b<span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>
<span style="color: #008000;">&#125;</span>
&nbsp;
VALUE hellotest <span style="color: #000080;">=</span> Qnil<span style="color: #008080;">;</span> <span style="color: #666666;">//Qnil 即为 NULL </span>
<span style="color: #ff0000; font-style: italic;">/*
如果全部都是C的，则需要加上extern &quot;C&quot; void Init_HelloTest()
*/</span>
<span style="color: #0000ff;">void</span> Init_HelloTest<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#123;</span>  
  hellotest <span style="color: #000080;">=</span> rb_define_module<span style="color: #008000;">&#40;</span><span style="color: #FF0000;">&quot;HelloTest&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  
  <span style="color: #666666;">//定义一个ruby方法，在ruby中调用。最后一个参数为 ruby方法的参数个数 </span>
  rb_define_method<span style="color: #008000;">&#40;</span>hellotest, <span style="color: #FF0000;">&quot;sayhello&quot;</span>, RUBY_METHOD_FUNC<span style="color: #008000;">&#40;</span>method_sayhello<span style="color: #008000;">&#41;</span>, <span style="color: #0000dd;">1</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>  
  rb_define_method<span style="color: #008000;">&#40;</span>hellotest, <span style="color: #FF0000;">&quot;cfunction_plus&quot;</span>, RUBY_METHOD_FUNC<span style="color: #008000;">&#40;</span>method_cfunction<span style="color: #008000;">&#41;</span>, <span style="color: #0000dd;">2</span><span style="color: #008000;">&#41;</span><span style="color: #008080;">;</span>   
<span style="color: #008000;">&#125;</span><span style="color: #008080;">;</span></pre></div></div>

<p>上述代码，实现了两个ruby方法：sayhello和cfunction_plus<br />
像返回值，参数值必须要注意类型，C和ruby之间的转换，可以参见Programming Ruby一书第280页。同时也有说到其他的方法。</p>
<p>2. extconf.rb</p>

<div class="wp_syntax"><div class="code"><pre class="ruby" style="font-family:monospace;"><span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'mkmf'</span>  
&nbsp;
extension_name = <span style="color:#996600;">&quot;HelloTest&quot;</span> 
dirbase=<span style="color:#996600;">&quot;D:/ruby/vc&quot;</span>
ruby_lib_base= dirbase<span style="color:#006600; font-weight:bold;">+</span><span style="color:#996600;">&quot;/lib&quot;</span>
ruby_include_base= dirbase<span style="color:#006600; font-weight:bold;">+</span><span style="color:#996600;">&quot;/include&quot;</span>
&nbsp;
dir_config<span style="color:#006600; font-weight:bold;">&#40;</span>extension_name<span style="color:#006600; font-weight:bold;">&#41;</span>  
<span style="color:#008000; font-style:italic;">#如果是windows则取消下面注释，注意，目录名称不能有空格</span>
<span style="color:#008000; font-style:italic;">#dir_config(extension_name,ruby_include_base,ruby_lib_base)</span>
&nbsp;
create_makefile<span style="color:#006600; font-weight:bold;">&#40;</span>extension_name<span style="color:#006600; font-weight:bold;">&#41;</span></pre></div></div>

<p>之后运行 ruby extconf.rb,以便生成Makefile文件。</p>
<p>linux下，一般直接运行make即可生成so，然后make install 即可。<br />
windows下，必须装有visual studio，然后使用nmake即可。<br />
visual studio要注意版本问题，直接去掉ruby的头文件判断吧:<br />
ruby安装目录下： D:\ruby\ruby186\lib\ruby\1.8\i386-mswin32<br />
config.h第二行注释掉即可：<br />
#if _MSC_VER != 1200<br />
//#error MSC version unmatch<br />
#endif<br />
然后使用nmake编译。<br />
关于VC++ 7.0以上版本有一些特殊情况，就是manifest文件，这是发布一个.exe的可执行文件或者一个.dll的动态库所需要的，默认情况下，.manifest文件需要内嵌到你的类库中去。可使用下述批处理脚本：</p>

<div class="wp_syntax"><div class="code"><pre class="dos" style="font-family:monospace;">ruby extconf.rb  
nmake  clean
nmake  
mt -manifest <span style="color: #33cc33;">%</span><span style="color: #448888;">1</span>.so.manifest -outputresource:<span style="color: #33cc33;">%</span><span style="color: #448888;">1</span>.so;2  
nmake install</pre></div></div>

<p>如果没有错误，编译通过，windows下可以使用如下命令查看dll导出函数情况：<br />
dumpbin -exports HelloTest.so<br />
。。。<br />
1 0 00001120 Init_HelloTest = ?Init_HelloTest@@YAXXZ (void __cdecl Init_HelloTest(void))<br />
。。。<br />
linux下： nm -g HelloTest.so<br />
最后附上ruby测试脚本：</p>

<div class="wp_syntax"><div class="code"><pre class="ruby" style="font-family:monospace;"><span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">&quot;HelloTest&quot;</span>
&nbsp;
<span style="color:#9966CC; font-weight:bold;">include</span> HelloTest  
&nbsp;
<span style="color:#CC0066; font-weight:bold;">puts</span> HelloTest.<span style="color:#9900CC;">sayhello</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;aaa&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
<span style="color:#CC0066; font-weight:bold;">puts</span> HelloTest.<span style="color:#9900CC;">cfunction_plus</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006666;">111</span>,<span style="color:#006666;">222</span><span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
<span style="color:#CC0066; font-weight:bold;">puts</span> HelloTest.<span style="color:#9900CC;">methods</span> <span style="color:#006600; font-weight:bold;">-</span> <span style="color:#CC00FF; font-weight:bold;">Object</span>.<span style="color:#9900CC;">methods</span></pre></div></div>

<p>注意：如果是在扩展中有输出，则只有在ruby的输出全部打印完毕后，才会有扩展中的输出(直接使用ruby test.rb，顺序有正常。。。暂时无解。。。)。<br />
本例的打印结果：</p>
<blockquote><p>
aaa<br />
333<br />
Ruby C/C++ extention Example cdlz.<br />
Your Name is: aaa</p></blockquote>
]]></content:encoded>
			<wfw:commentRss>http://imzc.net/archives/229/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>ruby使用win32ole和win32api</title>
		<link>http://imzc.net/archives/227/</link>
		<comments>http://imzc.net/archives/227/#comments</comments>
		<pubDate>Fri, 23 Mar 2012 08:42:57 +0000</pubDate>
		<dc:creator>imzc</dc:creator>
				<category><![CDATA[Ruby&Testing]]></category>

		<guid isPermaLink="false">http://imzc.net/?p=227</guid>
		<description><![CDATA[ruby提供的功能比较强大，能直接调用win32 api，还能使用OLE组建。 一、 win32 ole调用： [...]]]></description>
			<content:encoded><![CDATA[<p>ruby提供的功能比较强大，能直接调用win32 api，还能使用OLE组建。<br />
一、 win32 ole调用：</p>

<div class="wp_syntax"><div class="code"><pre class="ruby" style="font-family:monospace;"><span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">&quot;win32ole&quot;</span>
i = WIN32OLE.<span style="color:#9900CC;">new</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">'AutoItX3.Control'</span><span style="color:#006600; font-weight:bold;">&#41;</span> <span style="color:#008000; font-style:italic;">#使用AutoIt工具的OLE</span>
<span style="color:#CC0066; font-weight:bold;">puts</span> i.<span style="color:#9900CC;">ole_methods</span> <span style="color:#008000; font-style:italic;">#打印出所有支持的方法</span>
i.<span style="color:#9900CC;">Run</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;calc.exe&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span></pre></div></div>

<p>二。 win32 api调用：<br />
由于涉及到一些结构体，自己使用二进制方法比较麻烦，可以使用已有的CStruct gem包来处理。<br />
安装步骤和简单介绍见：<a href="http://www.w-yong.com/docs/ruby_win32_api.html" target="_blank"> http://www.w-yong.com/docs/ruby_win32_api.html</a><br />
官方的一个事例：</p>

<div class="wp_syntax"><div class="code"><pre class="ruby" style="font-family:monospace;"><span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'windows/memory'</span>
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'win32struct'</span>
&nbsp;
<span style="color:#9966CC; font-weight:bold;">include</span> <span style="color:#6666ff; font-weight:bold;">Windows::Memory</span>
&nbsp;
<span style="color:#008000; font-style:italic;"># example:</span>
&nbsp;
<span style="color:#008000; font-style:italic;"># typedef struct _MEMORYSTATUS {</span>
<span style="color:#008000; font-style:italic;">#     DWORD dwLength;</span>
<span style="color:#008000; font-style:italic;">#     DWORD dwMemoryLoad;</span>
<span style="color:#008000; font-style:italic;">#     DWORD dwTotalPhys;</span>
<span style="color:#008000; font-style:italic;">#     DWORD dwAvailPhys;</span>
<span style="color:#008000; font-style:italic;">#     DWORD dwTotalPageFile;</span>
<span style="color:#008000; font-style:italic;">#     DWORD dwAvailPageFile;</span>
<span style="color:#008000; font-style:italic;">#     DWORD dwTotalVirtual;</span>
<span style="color:#008000; font-style:italic;">#     DWORD dwAvailVirtual;</span>
<span style="color:#008000; font-style:italic;"># } MEMORYSTATUS, *LPMEMORYSTATUS;</span>
&nbsp;
<span style="color:#9966CC; font-weight:bold;">class</span> MEMORYSTATUS <span style="color:#006600; font-weight:bold;">&lt;</span> Win32Struct
    DWORD <span style="color:#ff3333; font-weight:bold;">:dwLength</span>
    DWORD <span style="color:#ff3333; font-weight:bold;">:dwMemoryLoad</span>
    DWORD <span style="color:#ff3333; font-weight:bold;">:dwTotalPhys</span>
    DWORD <span style="color:#ff3333; font-weight:bold;">:dwAvailPhys</span>
    DWORD <span style="color:#ff3333; font-weight:bold;">:dwTotalPageFile</span>
    DWORD <span style="color:#ff3333; font-weight:bold;">:dwAvailPageFile</span>
    DWORD <span style="color:#ff3333; font-weight:bold;">:dwTotalVirtual</span>
    DWORD <span style="color:#ff3333; font-weight:bold;">:dwAvailVirtual</span>
<span style="color:#9966CC; font-weight:bold;">end</span>
&nbsp;
<span style="color:#008000; font-style:italic;"># create a MEMORYSTATUS's instance</span>
stat = MEMORYSTATUS.<span style="color:#9900CC;">new</span> <span style="color:#006600; font-weight:bold;">&#123;</span><span style="color:#006600; font-weight:bold;">|</span>st<span style="color:#006600; font-weight:bold;">|</span> st.<span style="color:#9900CC;">dwLength</span> = MEMORYSTATUS.<span style="color:#9900CC;">size</span> <span style="color:#006600; font-weight:bold;">&#125;</span>
&nbsp;
<span style="color:#008000; font-style:italic;"># call API &quot;GlobalMemoryStatus&quot; - See also MSDN</span>
GlobalMemoryStatus<span style="color:#006600; font-weight:bold;">&#40;</span>stat.<span style="color:#9900CC;">data</span><span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
<span style="color:#008000; font-style:italic;">#output</span>
<span style="color:#CC0066; font-weight:bold;">printf</span> <span style="color:#996600;">&quot;[Physical Memory]<span style="color:#000099;">\n</span>&quot;</span>
<span style="color:#CC0066; font-weight:bold;">printf</span> <span style="color:#996600;">&quot;  total:%12d bytes<span style="color:#000099;">\n</span>&quot;</span>,stat.<span style="color:#9900CC;">dwTotalPhys</span>
<span style="color:#CC0066; font-weight:bold;">printf</span> <span style="color:#996600;">&quot;  free :%12d bytes<span style="color:#000099;">\n</span>&quot;</span>,stat.<span style="color:#9900CC;">dwAvailPhys</span>
&nbsp;
<span style="color:#CC0066; font-weight:bold;">printf</span> <span style="color:#996600;">&quot;[Virtual Memory]<span style="color:#000099;">\n</span>&quot;</span>
<span style="color:#CC0066; font-weight:bold;">printf</span> <span style="color:#996600;">&quot;  total:%12d bytes<span style="color:#000099;">\n</span>&quot;</span>,stat.<span style="color:#9900CC;">dwTotalVirtual</span>
<span style="color:#CC0066; font-weight:bold;">printf</span> <span style="color:#996600;">&quot;  free :%12d bytes<span style="color:#000099;">\n</span>&quot;</span>,stat.<span style="color:#9900CC;">dwAvailVirtual</span>
&nbsp;
<span style="color:#CC0066; font-weight:bold;">printf</span> <span style="color:#996600;">&quot;[Paging File]<span style="color:#000099;">\n</span>&quot;</span>
<span style="color:#CC0066; font-weight:bold;">printf</span> <span style="color:#996600;">&quot;  total:%12d bytes<span style="color:#000099;">\n</span>&quot;</span>,stat.<span style="color:#9900CC;">dwTotalPageFile</span>
<span style="color:#CC0066; font-weight:bold;">printf</span> <span style="color:#996600;">&quot;  free :%12d bytes<span style="color:#000099;">\n</span>&quot;</span>,stat.<span style="color:#9900CC;">dwAvailPageFile</span></pre></div></div>

<p>&nbsp;<br />
运行结果:<br />
<code><br />
E:\att_proj\RubyStudy\lib>ruby cstruct.rb<br />
[Physical Memory]<br />
  total:  2147483647 bytes<br />
  free :  2126528512 bytes<br />
[Virtual Memory]<br />
  total:  2147352576 bytes<br />
  free :  2082926592 bytes<br />
[Paging File]<br />
  total:  4294967295 bytes<br />
  free :  4294967295 bytes<br />
</code></p>
]]></content:encoded>
			<wfw:commentRss>http://imzc.net/archives/227/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Ruby使用xml-rpc对emlog进行发帖，编辑等操作</title>
		<link>http://imzc.net/archives/226/</link>
		<comments>http://imzc.net/archives/226/#comments</comments>
		<pubDate>Thu, 22 Mar 2012 13:02:37 +0000</pubDate>
		<dc:creator>imzc</dc:creator>
				<category><![CDATA[Ruby&Testing]]></category>

		<guid isPermaLink="false">http://imzc.net/?p=226</guid>
		<description><![CDATA[Ruby本身自带了xmlrpc功能，使用很简单。 require &#8220;xmlrpc/client&# [...]]]></description>
			<content:encoded><![CDATA[<p>Ruby本身自带了xmlrpc功能，使用很简单。</p>
<p>require &#8220;xmlrpc/client&#8221;</p>
<p>ok,res =  xmlrpc.call2(method, *argvs)</p>
<p>emlog本身对xmlrpc只是不完全支持，针对创建时间，貌似没有找到对应的object类型，没法了，直接修改emlog的xmlrpc.php：</p>

<div class="wp_syntax"><div class="code"><pre class="php" style="font-family:monospace;">line <span style="color: #cc66cc;">170</span><span style="color: #339933;">:</span>
<span style="color: #666666; font-style: italic;">// 发布时间</span>
	<span style="color: #666666; font-style: italic;">/*if (isset($data['dateCreated']) &amp;&amp; is_object($data['dateCreated'])) {
		$update_data['date'] = @gmmktime($data['dateCreated']-&gt;hour, $data['dateCreated']-&gt;minute , $data['dateCreated']-&gt;second , $data['dateCreated']-&gt;month , $data['dateCreated']-&gt;day , $data['dateCreated']-&gt;year) - $options_cache['timezone'] * 3600;
	}*/</span>
	<span style="color: #666666; font-style: italic;">//timstamp</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #990000;">isset</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$data</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'dateCreated'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
		<span style="color: #000088;">$update_data</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'date'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$data</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'dateCreated'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">&#125;</span><span style="color: #b1b100;">else</span> <span style="color: #009900;">&#123;</span>
		<span style="color: #000088;">$update_data</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'date'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #990000;">time</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">&#125;</span>
&nbsp;
&nbsp;
line226<span style="color: #339933;">:</span>
	<span style="color: #666666; font-style: italic;">// 发布时间</span>
&nbsp;
	<span style="color: #666666; font-style: italic;">//var_dump($data['dateCreated']);die();</span>
	<span style="color: #666666; font-style: italic;">/*if (isset($data['dateCreated']) &amp;&amp; is_object($data['dateCreated'])) {
		$update_data['date'] = @gmmktime($data['dateCreated']-&gt;hour, $data['dateCreated']-&gt;minute , $data['dateCreated']-&gt;second , $data['dateCreated']-&gt;month , $data['dateCreated']-&gt;day , $data['dateCreated']-&gt;year) - $options_cache['timezone'] * 3600;
	}*/</span>
	<span style="color: #666666; font-style: italic;">//timstamp</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #990000;">isset</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$data</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'dateCreated'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
		<span style="color: #000088;">$update_data</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'date'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$data</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'dateCreated'</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">&#125;</span></pre></div></div>

<p>&nbsp;<br />
下面的ruby代码实现了查询分类，发表文章，编辑文章功能：</p>

<div class="wp_syntax"><div class="code"><pre class="ruby" style="font-family:monospace;"><span style="color:#008000; font-style:italic;"># To change this template, choose Tools | Templates</span>
<span style="color:#008000; font-style:italic;"># and open the template in the editor.</span>
&nbsp;
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">&quot;xmlrpc/client&quot;</span>
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'time'</span>
&nbsp;
<span style="color:#9966CC; font-weight:bold;">def</span> nr2br<span style="color:#006600; font-weight:bold;">&#40;</span>str<span style="color:#006600; font-weight:bold;">&#41;</span>
  <span style="color:#0000FF; font-weight:bold;">return</span> str.<span style="color:#CC0066; font-weight:bold;">gsub</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006600; font-weight:bold;">/</span>\n<span style="color:#006600; font-weight:bold;">/</span>,<span style="color:#996600;">&quot;&lt;br&gt;&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
<span style="color:#9966CC; font-weight:bold;">end</span>
&nbsp;
<span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;xmlrpc client test&quot;</span>
&nbsp;
&nbsp;
host = <span style="color:#996600;">&quot;192.168.12.103&quot;</span>
path = <span style="color:#996600;">&quot;/emlog/xmlrpc.php&quot;</span>
&nbsp;
&nbsp;
xmlrpc = <span style="color:#6666ff; font-weight:bold;">XMLRPC::Client</span>.<span style="color:#9900CC;">new</span><span style="color:#006600; font-weight:bold;">&#40;</span>host,path <span style="color:#006600; font-weight:bold;">&#41;</span>
username = <span style="color:#996600;">&quot;admin&quot;</span>
userpwd = <span style="color:#996600;">&quot;sinfors&quot;</span>
is_publish = <span style="color:#006666;">1</span>
&nbsp;
&nbsp;
method = <span style="color:#996600;">&quot;metaWeblog.getCategories&quot;</span>
ok,res =  xmlrpc.<span style="color:#9900CC;">call2</span><span style="color:#006600; font-weight:bold;">&#40;</span>method,  <span style="color:#006666;">0</span>,username,userpwd<span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
<span style="color:#9966CC; font-weight:bold;">if</span> ok == <span style="color:#0000FF; font-weight:bold;">false</span>
  <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;error:#{res}&quot;</span>
<span style="color:#9966CC; font-weight:bold;">else</span>
  <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;success,Categories:#{res}&quot;</span>
<span style="color:#9966CC; font-weight:bold;">end</span>
res = <span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#006600; font-weight:bold;">&#123;</span><span style="color:#996600;">&quot;title&quot;</span><span style="color:#006600; font-weight:bold;">=&gt;</span><span style="color:#996600;">&quot;未分类&quot;</span><span style="color:#006600; font-weight:bold;">&#125;</span><span style="color:#006600; font-weight:bold;">&#93;</span> <span style="color:#9966CC; font-weight:bold;">if</span> res == <span style="color:#0000FF; font-weight:bold;">nil</span>
&nbsp;
method = <span style="color:#996600;">&quot;metaWeblog.newPost&quot;</span>
&nbsp;
add_time = <span style="color:#CC00FF; font-weight:bold;">Time</span>.<span style="color:#9900CC;">new</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006666;">2012</span>,<span style="color:#006666;">3</span>,<span style="color:#006666;">20</span>,<span style="color:#006666;">15</span>,<span style="color:#006666;">25</span>,<span style="color:#006666;">0</span>, <span style="color:#996600;">&quot;+08:00&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">to_i</span>
&nbsp;
<span style="color:#008000; font-style:italic;">#add_time = {:year=&gt;2012,:month=&gt;3, :day=&gt;2, :hour=&gt;3, :min=&gt;30, :sec=&gt;3}</span>
&nbsp;
<span style="color:#008000; font-style:italic;">#  &quot;dateCreated&quot;=&gt;#&lt;XMLRPC::DateTime:0xffcf00 @year=2012, @month=3, @day=23, @hour=4, @min=25, @sec=17&gt;,</span>
&nbsp;
data_hash = <span style="color:#006600; font-weight:bold;">&#123;</span>:title<span style="color:#006600; font-weight:bold;">=&gt;</span><span style="color:#996600;">&quot;Ruby xmlrpc: call(method, *args)&quot;</span>,
  <span style="color:#ff3333; font-weight:bold;">:description</span><span style="color:#006600; font-weight:bold;">=&gt;</span>nr2br<span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;# File xmlrpc/client.rb, line 409
}
def call(method, *args)
  ok, param = call2(method, *args)
  if ok
    param
  else
    raise param
  end
end&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>,
  <span style="color:#ff3333; font-weight:bold;">:categories</span><span style="color:#006600; font-weight:bold;">=&gt;</span>res<span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#006666;">0</span><span style="color:#006600; font-weight:bold;">&#93;</span><span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#996600;">'title'</span><span style="color:#006600; font-weight:bold;">&#93;</span>.<span style="color:#9900CC;">to_s</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006600; font-weight:bold;">&#41;</span>,
  <span style="color:#ff3333; font-weight:bold;">:mt_keywords</span><span style="color:#006600; font-weight:bold;">=&gt;</span><span style="color:#996600;">&quot;ruby,call,xmlrpc&quot;</span>,
  <span style="color:#ff3333; font-weight:bold;">:dateCreated</span><span style="color:#006600; font-weight:bold;">=&gt;</span>add_time
  <span style="color:#006600; font-weight:bold;">&#125;</span>
&nbsp;
<span style="color:#CC0066; font-weight:bold;">puts</span> res<span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#006666;">0</span><span style="color:#006600; font-weight:bold;">&#93;</span><span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#996600;">'title'</span><span style="color:#006600; font-weight:bold;">&#93;</span>.<span style="color:#9900CC;">to_s</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
ok,res =  xmlrpc.<span style="color:#9900CC;">call2</span><span style="color:#006600; font-weight:bold;">&#40;</span>method,  <span style="color:#006666;">0</span>,username,userpwd,data_hash,is_publish<span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
<span style="color:#9966CC; font-weight:bold;">if</span> ok == <span style="color:#0000FF; font-weight:bold;">false</span> 
  <span style="color:#CC0066; font-weight:bold;">raise</span> <span style="color:#CC00FF; font-weight:bold;">Exception</span>,<span style="color:#996600;">&quot;error:#{res}&quot;</span>
<span style="color:#9966CC; font-weight:bold;">else</span>
  <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;success,new aritle:#{res}&quot;</span>
<span style="color:#9966CC; font-weight:bold;">end</span> 
article_id = res.<span style="color:#9900CC;">to_i</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
&nbsp;
method = <span style="color:#996600;">&quot;metaWeblog.editPost&quot;</span>
data_hash<span style="color:#006600; font-weight:bold;">&#91;</span><span style="color:#ff3333; font-weight:bold;">:title</span><span style="color:#006600; font-weight:bold;">&#93;</span> = <span style="color:#996600;">&quot;edit....sss哈哈~&quot;</span>
&nbsp;
ok,res =  xmlrpc.<span style="color:#9900CC;">call2</span><span style="color:#006600; font-weight:bold;">&#40;</span>method,article_id,username,userpwd,data_hash,is_publish<span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
<span style="color:#9966CC; font-weight:bold;">if</span> ok == <span style="color:#0000FF; font-weight:bold;">false</span>
  <span style="color:#CC0066; font-weight:bold;">raise</span> <span style="color:#CC00FF; font-weight:bold;">Exception</span>,<span style="color:#996600;">&quot;error:#{res}&quot;</span>
<span style="color:#9966CC; font-weight:bold;">else</span>
  <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;success,new aritle:#{res}&quot;</span>
<span style="color:#9966CC; font-weight:bold;">end</span>
&nbsp;
&nbsp;
method = <span style="color:#996600;">&quot;metaWeblog.getPost&quot;</span>
&nbsp;
ok,res =  xmlrpc.<span style="color:#9900CC;">call2</span><span style="color:#006600; font-weight:bold;">&#40;</span>method,article_id,username,userpwd<span style="color:#006600; font-weight:bold;">&#41;</span>
<span style="color:#9966CC; font-weight:bold;">if</span> ok == <span style="color:#0000FF; font-weight:bold;">false</span>
  <span style="color:#CC0066; font-weight:bold;">raise</span> <span style="color:#CC00FF; font-weight:bold;">Exception</span>,<span style="color:#996600;">&quot;error:#{res}&quot;</span>
<span style="color:#9966CC; font-weight:bold;">else</span>
  <span style="color:#CC0066; font-weight:bold;">puts</span> <span style="color:#996600;">&quot;success,get aritle(#{article_id}):#{res}&quot;</span>
<span style="color:#9966CC; font-weight:bold;">end</span></pre></div></div>

]]></content:encoded>
			<wfw:commentRss>http://imzc.net/archives/226/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>ruby+watir在搜狐微博上面发表微博</title>
		<link>http://imzc.net/archives/206/</link>
		<comments>http://imzc.net/archives/206/#comments</comments>
		<pubDate>Wed, 07 Mar 2012 17:24:38 +0000</pubDate>
		<dc:creator>imzc</dc:creator>
				<category><![CDATA[Ruby&Testing]]></category>

		<guid isPermaLink="false">http://imzc.net/?p=206</guid>
		<description><![CDATA[ruby+watir在搜狐微博上面发表微博，有个问题是发表微博时，直接click不能响应，也就发表不能成功。  [...]]]></description>
			<content:encoded><![CDATA[<p>ruby+watir在搜狐微博上面发表微博，有个问题是发表微博时，直接click不能响应，也就发表不能成功。<br />
我们可以使用发送javascript事件，再进行。<br />
通过<a href="http://imzc.net/archives/203/javascript%e4%ba%8b%e4%bb%b6%e6%8d%95%e8%8e%b7%e5%88%a9%e5%99%a8-chrome%e5%bc%80%e5%8f%91%e4%ba%ba%e5%91%98%e5%b7%a5%e5%85%b7/" target="_blank">之前帖子</a>介绍，使用chrome的事件监听器，发现该【发表】链接仅响应mouseup事件。<br />
因此我们可以采取以下方案：</p>

<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre class="ruby" style="font-family:monospace;">C:\Users\server<span style="color:#006600; font-weight:bold;">&gt;</span>irb
irb<span style="color:#006600; font-weight:bold;">&#40;</span>main<span style="color:#006600; font-weight:bold;">&#41;</span>:001:<span style="color:#006666;">0</span><span style="color:#006600; font-weight:bold;">&gt;</span> <span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">'watir'</span>
<span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#0000FF; font-weight:bold;">true</span>
irb<span style="color:#006600; font-weight:bold;">&#40;</span>main<span style="color:#006600; font-weight:bold;">&#41;</span>:003:<span style="color:#006666;">0</span><span style="color:#006600; font-weight:bold;">&gt;</span> ie = <span style="color:#6666ff; font-weight:bold;">Watir::IE</span>.<span style="color:#9900CC;">new</span>
<span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#008000; font-style:italic;">#</span>
irb<span style="color:#006600; font-weight:bold;">&#40;</span>main<span style="color:#006600; font-weight:bold;">&#41;</span>:005:<span style="color:#006666;">0</span><span style="color:#006600; font-weight:bold;">&gt;</span> ie.<span style="color:#9900CC;">goto</span> <span style="color:#996600;">&quot;t.sohu.com&quot;</span>
<span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#006666;">134.898836</span>
irb<span style="color:#006600; font-weight:bold;">&#40;</span>main<span style="color:#006600; font-weight:bold;">&#41;</span>:006:<span style="color:#006666;">0</span><span style="color:#006600; font-weight:bold;">&gt;</span> ie.<span style="color:#9900CC;">text_field</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:id</span>,<span style="color:#996600;">&quot;email&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">set</span> <span style="color:#996600;">&quot;xxx@163.com&quot;</span>
<span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#996600;">&quot;&quot;</span>
irb<span style="color:#006600; font-weight:bold;">&#40;</span>main<span style="color:#006600; font-weight:bold;">&#41;</span>:007:<span style="color:#006666;">0</span><span style="color:#006600; font-weight:bold;">&gt;</span> ie.<span style="color:#9900CC;">text_field</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:id</span>,<span style="color:#996600;">&quot;password&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">set</span> <span style="color:#996600;">&quot;xxxx&quot;</span>
<span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#996600;">&quot;&quot;</span>
irb<span style="color:#006600; font-weight:bold;">&#40;</span>main<span style="color:#006600; font-weight:bold;">&#41;</span>:013:<span style="color:#006666;">0</span><span style="color:#006600; font-weight:bold;">*</span> ie.<span style="color:#9900CC;">link</span><span style="color:#006600; font-weight:bold;">&#40;</span>:<span style="color:#9966CC; font-weight:bold;">class</span>,<span style="color:#996600;">&quot;logbtn&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">click</span>
<span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#006666;">0.534028</span>
irb<span style="color:#006600; font-weight:bold;">&#40;</span>main<span style="color:#006600; font-weight:bold;">&#41;</span>:017:<span style="color:#006666;">0</span><span style="color:#006600; font-weight:bold;">*</span> ie.<span style="color:#9900CC;">text_field</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:name</span>,<span style="color:#996600;">&quot;tw_compser_textarea&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">set</span> <span style="color:#996600;">&quot;use watir&quot;</span>
&nbsp;
irb<span style="color:#006600; font-weight:bold;">&#40;</span>main<span style="color:#006600; font-weight:bold;">&#41;</span>:020:<span style="color:#006666;">0</span><span style="color:#006600; font-weight:bold;">&gt;</span> ie.<span style="color:#9900CC;">execute_script</span> <span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">'$(&quot;.postSub a&quot;).mouseup()'</span><span style="color:#006600; font-weight:bold;">&#41;</span>
<span style="color:#006600; font-weight:bold;">=&gt;</span> <span style="color:#996600;">&quot;[object Object]&quot;</span>
&nbsp;
<span style="color:#008000; font-style:italic;">#####################</span>
直接使用irb，使用下面的定位不到。。。囧.需要UTF8编码。。。
ie.<span style="color:#9900CC;">link</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:text</span>,<span style="color:#006600; font-weight:bold;">/</span>发\s<span style="color:#006600; font-weight:bold;">*</span>表<span style="color:#006600; font-weight:bold;">/</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">fireEvent</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;onmouseup&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>
&nbsp;
<span style="color:#008000; font-style:italic;">################################</span>
若要使用utf8，简单方式还是创建rb脚本：
<span style="color:#008000; font-style:italic;">#coding=utf-8</span>
<span style="color:#CC0066; font-weight:bold;">require</span> <span style="color:#996600;">&quot;watir&quot;</span>
ie = <span style="color:#6666ff; font-weight:bold;">Watir::IE</span>.<span style="color:#9900CC;">attach</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:url</span>,<span style="color:#006600; font-weight:bold;">/</span>sohu<span style="color:#006600; font-weight:bold;">/</span><span style="color:#006600; font-weight:bold;">&#41;</span>
ie.<span style="color:#9900CC;">text_field</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:name</span>,<span style="color:#996600;">&quot;tw_compser_textarea&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">set</span> <span style="color:#996600;">&quot;use watir utf8&quot;</span>
ie.<span style="color:#9900CC;">link</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#ff3333; font-weight:bold;">:text</span>,<span style="color:#006600; font-weight:bold;">/</span>发\s<span style="color:#006600; font-weight:bold;">*</span>表<span style="color:#006600; font-weight:bold;">/</span><span style="color:#006600; font-weight:bold;">&#41;</span>.<span style="color:#9900CC;">fireEvent</span><span style="color:#006600; font-weight:bold;">&#40;</span><span style="color:#996600;">&quot;onmouseup&quot;</span><span style="color:#006600; font-weight:bold;">&#41;</span></pre></td></tr></table></div>

<p>&nbsp;</p>
]]></content:encoded>
			<wfw:commentRss>http://imzc.net/archives/206/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
	</channel>
</rss>
