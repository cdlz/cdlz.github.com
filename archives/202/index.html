<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />

	<title>worldpress插件编写-WP_OTP | Only For Sunshine~</title>
	<link rel="alternate" type="application/rss+xml" title="RSS 2.0 - 所有文章" href="../../feed/index.html" />
	<link rel="alternate" type="application/rss+xml" title="RSS 2.0 - 所有评论" href="../../comments/feed/index.html" />
	<link rel="pingback" href="../../xmlrpc.php" />

	<!-- style START -->
	<link rel="stylesheet" href="../../wp-content/themes/elegant-box/style.css" type="text/css" media="screen" />
			<link rel="stylesheet" href="../../wp-content/themes/elegant-box/chinese.css" type="text/css" media="screen" />
		<!--[if IE]>
		<link rel="stylesheet" href="http://imzc.net/wp-content/themes/elegant-box/ie.css" type="text/css" media="screen" />
	<![endif]-->

	<!-- default style -->
			<link rel="stylesheet" href="../../wp-content/themes/elegant-box/styles/blue/default.css" type="text/css" media="screen" title="blue" />
		<link rel="stylesheet" href="../../wp-content/themes/elegant-box/styles/blue/global.css" type="text/css" media="screen" />
	
	<!-- others styles -->
	<link rel="stylesheet" href="../../wp-content/themes/elegant-box/styles/green/default.css" type="text/css" media="screen" title="green" />
	<link rel="stylesheet" href="../../wp-content/themes/elegant-box/styles/green/global.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="../../wp-content/themes/elegant-box/styles/purple/default.css" type="text/css" media="screen" title="purple" />
	<link rel="stylesheet" href="../../wp-content/themes/elegant-box/styles/purple/global.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="../../wp-content/themes/elegant-box/styles/brown/default.css" type="text/css" media="screen" title="brown" />
	<link rel="stylesheet" href="../../wp-content/themes/elegant-box/styles/brown/global.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="../../wp-content/themes/elegant-box/styles/white/default.css" type="text/css" media="screen" title="white" />
	<link rel="stylesheet" href="../../wp-content/themes/elegant-box/styles/white/global.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="../../wp-content/themes/elegant-box/styles/black/default.css" type="text/css" media="screen" title="black" />
	<link rel="stylesheet" href="../../wp-content/themes/elegant-box/styles/black/global.css" type="text/css" media="screen" />
	<!-- style END -->

	<!-- javascript START -->
			<script type="text/javascript" src="../../wp-content/themes/elegant-box/js/styleswitcher.js"></script>
		<script type="text/javascript" src="../../wp-content/themes/elegant-box/js/base.js"></script>
	<script type="text/javascript" src="../../wp-content/themes/elegant-box/js/menu.js"></script>
	<!-- javascript END -->

		<link rel='stylesheet' id='jquery.slimbox-css'  href='../../wp-content/plugins/slimbox/stylesheets/jquery.slimbox.css?ver=2.03' type='text/css' media='all' />
<link rel='stylesheet' id='wp-pagenavi-css'  href='../../wp-content/themes/elegant-box/pagenavi-css.css?ver=2.70' type='text/css' media='all' />
<script type='text/javascript' src='../../wp-includes/js/jquery/jquery.js?ver=1.7.2'></script>
<script type='text/javascript' src='../../wp-content/plugins/slimbox/javascript/jquery.slimbox.js?ver=2.03'></script>
<script type='text/javascript' src='../../wp-includes/js/json2.js?ver=2011-02-23'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var live_blogging = {"ajaxurl":"http:\/\/imzc.net\/wp-admin\/admin-ajax.php","update_effect":"top"};
/* ]]> */
</script>
<script type='text/javascript' src='../../wp-content/plugins/live-blogging/live-blogging.js?ver=3.4.1'></script>
<script type='text/javascript' src='../../wp-includes/js/comment-reply.js?ver=3.4.1'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../../wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='UIView使用图片为背景和图片适应屏幕' href='../190/index.html' />
<link rel='next' title='ruby基本知识巩固' href='../220/index.html' />
<meta name="generator" content="WordPress 3.4.1" />
<link rel='shortlink' href='http://wp.me/p19waf-3g' />

<!-- All in One SEO Pack 1.6.14.5 by Michael Torbert of Semper Fi Web Design[343,406] -->
<meta name="description" content="worldpress插件编写-WP_OTP,动态密码" />
<meta name="keywords" content="worldpress插件编写,wp_otp,动态密码" />
<link rel="canonical" href="index.html" />
<!-- /all in one seo pack -->
<script type="text/javascript">
	jQuery(document).ready(function($){	
	    var select = $('a[href$=".bmp"],a[href$=".gif"],a[href$=".jpg"],a[href$=".jpeg"], a[href$=".png"],a[href$=".BMP"],a[href$=".GIF"],a[href$=".JPG"],a[href$=".JPEG"],a[href$=".PNG"]');
		select.slimbox();
	});
</script>

<link rel="stylesheet" href="../../wp-content/themes/elegant-box/wp-syntax.css" type="text/css" media="screen" />
</head>


<body>
	<!-- header START -->
	<div id="header">
		<div class="inner">
			<div class="content">
				<div class="caption">
					<h1 id="title"><a href="../../index.html" title="-More Thinking,And Then Just do it~~~">Only For Sunshine~</a></h1>
					<div id="tagline">-More Thinking,And Then Just do it~~~</div>
				</div>

				<!-- search box -->
									<form action="http://www.google.com/cse" id="search_box" method="get">
						<div id="searchbox">
							<input type="text" id="searchtxt" class="textfield" name="q" size="24" />
							<input type="hidden" name="cx" value="007838838681523399853:u4canb53vle" />
							<input type="hidden" name="ie" value="UTF-8" />
						</div>
					</form>
				<script type="text/javascript">
//<![CDATA[
	var searchbox = document.getElementById("searchbox");
	var searchtxt = document.getElementById("searchtxt");
	var tiptext = "请输入关键字...";
	if(searchtxt.value == "" || searchtxt.value == tiptext) {
		searchtxt.className += " searchtip";
		searchtxt.value = tiptext;
	}
	searchtxt.onfocus = function(e) {
		if(searchtxt.value == tiptext) {
			searchtxt.value = "";
			searchtxt.className = searchtxt.className.replace(" searchtip", "");
		}
	}
	searchtxt.onblur = function(e) {
		if(searchtxt.value == "") {
			searchtxt.className += " searchtip";
			searchtxt.value = tiptext;
		}
	}
//]]>
</script>

				<!-- navigation START -->
				<ul id="navigation">

					<li class="page_item"><a href="../../index.html">首页</a></li>
					<li class="page_item page-item-260"><a href="../../ios/index.html">IOS_PROJ</a></li>
<li class="page_item page-item-164"><a href="../../wp_otp/index.html">WP_OTP</a></li>
<li class="page_item page-item-180"><a href="../../vps-recommended/index.html">vps推荐</a></li>
<li class="page_item page-item-139"><a href="../../mysites/index.html">我的站点</a></li>
<li class="page_item page-item-2"><a href="../../aboutme/index.html">关于</a></li>
					<li id="subscribe">
						<a rel="external nofollow" title="订阅这个博客的文章" id="feed" href="../../feed/index.html"><img src="../../wp-content/themes/elegant-box/images/transparent.gif" alt="RSS 订阅" /></a>
													<ul>
								<li class="first"><a rel="external nofollow" title="订阅到有道" href="http://reader.youdao.com/b.do?url=http://imzc.net/feed/"> 有道</a></li>
								<li><a rel="external nofollow" title="订阅到鲜果" href="http://www.xianguo.com/subscribe.php?url=http://imzc.net/feed/"> 鲜果</a></li>
								<li><a rel="external nofollow" title="订阅到抓虾" href="http://www.zhuaxia.com/add_channel.php?url=http://imzc.net/feed/"> 抓虾</a></li>
								<li><a rel="external nofollow" title="订阅到 Google" href="http://fusion.google.com/add?feedurl=http://imzc.net/feed/">  Google</a></li>
								<li><a rel="external nofollow" title="订阅到 My Yahoo!" href="http://add.my.yahoo.com/rss?url=http://imzc.net/feed/">  My Yahoo!</a></li>
								<li><a rel="external nofollow" title="订阅到 newsgator" href="http://www.newsgator.com/ngs/subscriber/subfext.aspx?url=http://imzc.net/feed/">  newsgator</a></li>
								<li><a rel="external nofollow" title="订阅到 Bloglines" href="http://www.bloglines.com/sub/http://imzc.net/feed/">  Bloglines</a></li>
								<li><a rel="external nofollow" title="订阅到 哪吒" href="http://inezha.com/add?url=http://imzc.net/feed/">  哪吒</a></li>
							</ul>
											</li>

				</ul>
				<!-- navigation END -->

			</div>
		</div>
	</div>
	<!-- header END -->

	<div id="container">
		<div id="content">
			<div id="main">

		
			<div class="post">
				<div class="title">
					<h2>worldpress插件编写-WP_OTP</h2>
					<div class="fixed"></div>
				</div>

				<div class="info">
					
					<span>2012年2月11日</span>
											<span> | 分类: <a href="../category/ios-dev/index.html" title="查看 IOSDev 中的全部文章" rel="category tag">IOSDev</a>, <a href="../category/lamp/index.html" title="查看 LAMP 中的全部文章" rel="category tag">LAMP</a>, <a href="../category/project/index.html" title="查看 Project 中的全部文章" rel="category tag">Project</a></span>
																<span> | 标签: </span>
					
					<div class="fixed"></div>
				</div>

				<div class="content">
<div style=”padding:3px 0″>
<script type="text/javascript"><!--
google_ad_client = "pub-7220882232307827";
/* blog_468x15, Created @09-2-19 */
google_ad_slot = "1127450986";
google_ad_width = 468;
google_ad_height = 15;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div>
<br />	
					<p>worldpress插件编写-WP_OTP,结合多个示例,理解后编写而成.<br />
实际运行效果和介绍见:<a href="../../wp_otp/index.html" target="_blank">WP_OTP</a></p>

<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
</pre></td><td class="code"><pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">&lt;?php</span>
 <span style="color: #666666; font-style: italic;">/*
 Plugin Name: OATH_OTP
 Plugin URI: http://imzc.net/wp_otp
 Version: 0.0.1
 Author: Richard Chou
 Description: OATH_OTP
 */</span>
&nbsp;
<span style="color: #666666; font-style: italic;">// error_reporting(E_ALL);</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">global</span> <span style="color: #000088;">$shakehand_key</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #666666; font-style: italic;">//20bit</span>
<span style="color: #000088;">$shakehand_key</span> <span style="color: #339933;">=</span> get_option<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;shakehand_key&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #666666; font-style: italic;">//translate language, not completed.</span>
<span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span><span style="color: #990000;">function_exists</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'tr'</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
	<span style="color: #000000; font-weight: bold;">function</span> tr<span style="color: #009900;">&#40;</span><span style="color: #000088;">$str</span> <span style="color: #339933;">,</span><span style="color: #000088;">$section</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
		<span style="color: #b1b100;">return</span> <span style="color: #000088;">$str</span> <span style="color: #339933;">;</span>
	<span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
&nbsp;
<span style="color: #000000; font-weight: bold;">function</span> auth_check<span style="color: #009900;">&#40;</span><span style="color: #000088;">$clientSideSha1Str</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
	<span style="color: #000000; font-weight: bold;">global</span> <span style="color: #000088;">$shakehand_key</span><span style="color: #339933;">;</span>
	<span style="color: #666666; font-style: italic;">//die($shakehand_key);</span>
	<span style="color: #000088;">$seed</span> <span style="color: #339933;">=</span> <span style="color: #990000;">time</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
	<span style="color: #000088;">$seed</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$seed</span> <span style="color: #339933;">-</span> <span style="color: #000088;">$seed</span><span style="color: #339933;">%</span><span style="color:#800080;">30</span> <span style="color: #339933;">;</span>
	<span style="color: #666666; font-style: italic;">//$clientSideSha1Str = sha1($code.$shakehand_key);</span>
	<span style="color: #000088;">$webSideSha1Str</span> <span style="color: #339933;">=</span><span style="color: #990000;">sha1</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$seed</span><span style="color: #339933;">.</span><span style="color: #000088;">$shakehand_key</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
	<span style="color: #666666; font-style: italic;">//echo &quot;====seed:$seed=====&quot;.$webSideSha1Str.&quot;,&quot;.$clientSideSha1Str.&quot;===&quot;;</span>
&nbsp;
	<span style="color: #000088;">$clientSideCode</span> <span style="color: #339933;">=</span> <span style="color: #990000;">substr</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$clientSideSha1Str</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">6</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
	<span style="color: #000088;">$webSideCode</span> <span style="color: #339933;">=</span> <span style="color: #990000;">substr</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$webSideSha1Str</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">6</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$clientSideCode</span> <span style="color: #339933;">==</span> <span style="color: #000088;">$webSideCode</span> <span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
		<span style="color: #b1b100;">return</span> <span style="color: #009900; font-weight: bold;">true</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">&#125;</span><span style="color: #b1b100;">else</span><span style="color: #009900;">&#123;</span>
		<span style="color: #b1b100;">return</span> <span style="color: #009900; font-weight: bold;">false</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span>
<span style="color: #666666; font-style: italic;">// this function adds captcha to the login form</span>
<span style="color: #000000; font-weight: bold;">function</span> oath_login_form<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
	<span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span> <span style="color: #990000;">session_id</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #0000ff;">&quot;&quot;</span> <span style="color: #009900;">&#41;</span>
		<span style="color: #990000;">session_start</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
	<span style="color: #000000; font-weight: bold;">global</span> <span style="color: #000088;">$cptch_options</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;">// captcha html - login form</span>
	<span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">'&lt;p class=&quot;cptch_block&quot;&gt;'</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">&quot;&quot;</span> <span style="color: #339933;">!=</span> <span style="color: #000088;">$cptch_options</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_label_form'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span>	
		<span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">'&lt;label&gt;'</span><span style="color: #339933;">.</span> <span style="color: #990000;">stripslashes</span><span style="color: #009900;">&#40;</span> <span style="color: #000088;">$cptch_options</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_label_form'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span><span style="color: #0000ff;">'&lt;/label&gt;&lt;br /&gt;'</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span> <span style="color: #990000;">isset</span><span style="color: #009900;">&#40;</span> <span style="color: #000088;">$_SESSION</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_error'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
		<span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">&quot;&lt;br /&gt;&lt;span style='color:red'&gt;&quot;</span><span style="color: #339933;">.</span> <span style="color: #000088;">$_SESSION</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_error'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">.</span><span style="color: #0000ff;">&quot;&lt;/span&gt;&lt;br /&gt;&quot;</span><span style="color: #339933;">;</span>
		<span style="color: #990000;">unset</span><span style="color: #009900;">&#40;</span> <span style="color: #000088;">$_SESSION</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_error'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">&#125;</span>
	<span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">'&lt;br /&gt;'</span><span style="color: #339933;">;</span>
	oath_display_captcha<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">'&lt;/p&gt;
	&lt;br /&gt;'</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">return</span> <span style="color: #009900; font-weight: bold;">true</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #009900;">&#125;</span> <span style="color: #666666; font-style: italic;">//  end function oath_login_form</span>
&nbsp;
<span style="color: #666666; font-style: italic;">// this function checks captcha posted with a login</span>
<span style="color: #000000; font-weight: bold;">function</span> oath_login_post<span style="color: #009900;">&#40;</span><span style="color: #000088;">$errors</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
	<span style="color: #000000; font-weight: bold;">global</span> <span style="color: #000088;">$str_key</span><span style="color: #339933;">;</span>
	<span style="color: #000088;">$str_key</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;123&quot;</span><span style="color: #339933;">;</span>
	<span style="color: #666666; font-style: italic;">// Delete errors, if they set</span>
	<span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span> <span style="color: #990000;">isset</span><span style="color: #009900;">&#40;</span> <span style="color: #000088;">$_SESSION</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_error'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#41;</span>
		<span style="color: #990000;">unset</span><span style="color: #009900;">&#40;</span> <span style="color: #000088;">$_SESSION</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_error'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span> <span style="color: #990000;">isset</span><span style="color: #009900;">&#40;</span> <span style="color: #000088;">$_REQUEST</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'action'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #0000ff;">'register'</span> <span style="color: #339933;">==</span> <span style="color: #000088;">$_REQUEST</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'action'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span>
		<span style="color: #b1b100;">return</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$errors</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;">// If captcha not complete, return error</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span> <span style="color: #990000;">isset</span><span style="color: #009900;">&#40;</span> <span style="color: #000088;">$_REQUEST</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_number'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #0000ff;">&quot;&quot;</span> <span style="color: #339933;">==</span>  <span style="color: #000088;">$_REQUEST</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_number'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>	
		<span style="color: #b1b100;">return</span> <span style="color: #000088;">$errors</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'&lt;strong&gt;'</span><span style="color: #339933;">.</span> tr<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'ERROR'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'captcha'</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span><span style="color: #0000ff;">'&lt;/strong&gt;: '</span><span style="color: #339933;">.</span> tr<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'Please complete the CAPTCHA.'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'captcha'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">&#125;</span>
&nbsp;
	<span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span>auth_check<span style="color: #009900;">&#40;</span><span style="color: #990000;">trim</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$_REQUEST</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_number'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">===</span><span style="color: #009900; font-weight: bold;">true</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
		<span style="color: #666666; font-style: italic;">// captcha was matched						</span>
	<span style="color: #009900;">&#125;</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">&#123;</span>
		<span style="color: #b1b100;">return</span> <span style="color: #000088;">$errors</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'&lt;strong&gt;'</span><span style="color: #339933;">.</span> tr<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'ERROR'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'captcha'</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">.</span><span style="color: #0000ff;">'&lt;/strong&gt;: '</span><span style="color: #339933;">.</span> tr<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'That CAPTCHA was incorrect.'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'captcha'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">&#125;</span>
  <span style="color: #b1b100;">return</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$errors</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span> <span style="color: #666666; font-style: italic;">// end function oath_login_post</span>
&nbsp;
<span style="color: #666666; font-style: italic;">// this function checks the captcha posted with a login when login errors are absent</span>
<span style="color: #000000; font-weight: bold;">function</span> oath_login_check<span style="color: #009900;">&#40;</span><span style="color: #000088;">$url</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
	<span style="color: #000000; font-weight: bold;">global</span> <span style="color: #000088;">$str_key</span><span style="color: #339933;">;</span>
	<span style="color: #000000; font-weight: bold;">global</span> <span style="color: #000088;">$auth_tmp_key</span><span style="color: #339933;">;</span>
	<span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span> <span style="color: #990000;">session_id</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #0000ff;">&quot;&quot;</span> <span style="color: #009900;">&#41;</span>
		<span style="color: #990000;">session_start</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #000088;">$str_key</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;123&quot;</span><span style="color: #339933;">;</span>
	<span style="color: #666666; font-style: italic;">// Add error if captcha is empty</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span> <span style="color: #990000;">isset</span><span style="color: #009900;">&#40;</span> <span style="color: #000088;">$_REQUEST</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_number'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #0000ff;">&quot;&quot;</span> <span style="color: #339933;">==</span>  <span style="color: #000088;">$_REQUEST</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_number'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
		<span style="color: #000088;">$_SESSION</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_error'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> tr<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'Please complete the CAPTCHA.'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'captcha'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
		<span style="color: #666666; font-style: italic;">// Redirect to wp-login.php</span>
		<span style="color: #b1b100;">return</span> <span style="color: #000088;">$_SERVER</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">&quot;REQUEST_URI&quot;</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
	<span style="color: #009900;">&#125;</span>
	<span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span> <span style="color: #990000;">isset</span><span style="color: #009900;">&#40;</span> <span style="color: #000088;">$_REQUEST</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_result'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #990000;">isset</span><span style="color: #009900;">&#40;</span> <span style="color: #000088;">$_REQUEST</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_number'</span><span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
		<span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span>auth_check<span style="color: #009900;">&#40;</span><span style="color: #990000;">trim</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$_REQUEST</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_number'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">===</span><span style="color: #009900; font-weight: bold;">true</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
			<span style="color: #b1b100;">return</span> <span style="color: #000088;">$url</span><span style="color: #339933;">;</span>		<span style="color: #666666; font-style: italic;">// captcha was matched						</span>
		<span style="color: #009900;">&#125;</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">&#123;</span>
			<span style="color: #666666; font-style: italic;">// Add error if captcha is incorrect</span>
			<span style="color: #000088;">$_SESSION</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'cptch_error'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> tr<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'That CAPTCHA was incorrect.'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'captcha'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
			<span style="color: #666666; font-style: italic;">// Redirect to wp-login.php</span>
			<span style="color: #b1b100;">return</span> <span style="color: #000088;">$_SERVER</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">&quot;REQUEST_URI&quot;</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">&#125;</span>
	<span style="color: #009900;">&#125;</span>
	<span style="color: #b1b100;">else</span> <span style="color: #009900;">&#123;</span>
		<span style="color: #b1b100;">return</span> <span style="color: #000088;">$url</span><span style="color: #339933;">;</span>		<span style="color: #666666; font-style: italic;">// captcha was matched						</span>
	<span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span> <span style="color: #666666; font-style: italic;">// end function oath_login_post</span>
&nbsp;
&nbsp;
&nbsp;
<span style="color: #666666; font-style: italic;">// Functionality of the captcha logic work</span>
<span style="color: #000000; font-weight: bold;">function</span> oath_display_captcha<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
<span style="color: #009900;">&#123;</span>
	<span style="color: #000000; font-weight: bold;">global</span> <span style="color: #000088;">$cptch_options</span><span style="color: #339933;">,</span><span style="color: #000088;">$auth_tmp_key</span> <span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">global</span> <span style="color: #000088;">$shakehand_key</span><span style="color: #339933;">;</span>
&nbsp;
	<span style="color: #666666; font-style: italic;">// String for display </span>
	<span style="color: #000088;">$seed</span> <span style="color: #339933;">=</span> <span style="color: #990000;">time</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">?&gt;</span>
    OATH_OTP(<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">echo</span> <span style="color: #990000;">substr</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;<span style="color: #006699; font-weight: bold;">$seed</span>&quot;</span><span style="color: #339933;">,-</span><span style="color: #cc66cc;">3</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">3</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">?&gt;</span>):&lt;input type=&quot;text&quot; name=&quot;cptch_number&quot; tabindex=&quot;30&quot; value=&quot;&quot; maxlength=&quot;10&quot; size=&quot;1&quot; style=&quot;width:100px;margin-bottom:0;display:inline;&quot; /&gt;&lt;br /&gt;
	&lt;input type=&quot;hidden&quot; name=&quot;cptch_result&quot; value=&quot; <span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">echo</span> <span style="color: #000088;">$auth_tmp_key</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&quot; /&gt;&lt;input type=&quot;hidden&quot; value=&quot;Version: 0.0.1&quot; /&gt;
&nbsp;
<span style="color: #000000; font-weight: bold;">&lt;?php</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
&nbsp;
	add_action<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'login_form'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oath_login_form'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
	add_filter<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'login_errors'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oath_login_post'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
	add_filter<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'login_redirect'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oath_login_check'</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">10</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">3</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 
&nbsp;
&nbsp;
&nbsp;
<span style="color: #666666; font-style: italic;">// Function for display oather settings page in the admin area</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">function</span> oather_activate<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    add_option<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'shakehand_key'</span><span style="color: #339933;">,</span>  <span style="color: #0000ff;">&quot;testcoco&quot;</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #666666; font-style: italic;">//这里也可以用update_option，区别是使用update_action会在每一次重新启用插件时重置用户设置为默认值。</span>
&nbsp;
<span style="color: #009900;">&#125;</span>
register_activation_hook<span style="color: #009900;">&#40;</span><span style="color: #009900; font-weight: bold;">__FILE__</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oather_activate'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
&nbsp;
<span style="color: #000000; font-weight: bold;">function</span> oather_admin_init<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
    <span style="color: #666666; font-style: italic;">//注册配置，第3个参数是回调函数，用于过滤提交的内容</span>
	<span style="color: #666666; font-style: italic;">//register_setting( $option_group, $option_name, $sanitize_callback )</span>
    register_setting<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'shakehand_key'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oather_options'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oather_options_validate'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
	 <span style="color: #666666; font-style: italic;">//添加设置群</span>
	 <span style="color: #666666; font-style: italic;">//add_settings_section( $id, $title, $callback, $page ); </span>
    add_settings_section<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'oather_main'</span><span style="color: #339933;">,</span> tr<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Settings'</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'oath'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oather_section'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oather'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
   <span style="color: #666666; font-style: italic;">//添加具体配置</span>
    <span style="color: #666666; font-style: italic;">//add_settings_field( $id,                  $title,                               $callback,    $page,      $section,   $args );</span>
    add_settings_field<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'oather_shakehand_key'</span><span style="color: #339933;">,</span> tr<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'oather_shakehand_key'</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'oath'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oather_authkey'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oather'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oather_main'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 
&nbsp;
&nbsp;
<span style="color: #009900;">&#125;</span>
add_action<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'admin_init'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oather_admin_init'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
&nbsp;
&nbsp;
<span style="color: #000000; font-weight: bold;">function</span> oather_authkey<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
<span style="color: #009900;">&#123;</span>
    <span style="color: #000088;">$shakehand_key</span> <span style="color: #339933;">=</span> get_option<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'shakehand_key'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 
<span style="color: #666666; font-style: italic;">//	echo &quot;&lt;br&gt; $shakehand_key:&quot;;print_r($shakehand_key);</span>
<span style="color: #000000; font-weight: bold;">?&gt;</span>&lt;input id=&quot;oather_shakehand_key&quot; name=&quot;oather_shakehand_key&quot; style=&quot;width:200px;&quot; maxlength=&quot;20&quot;  value=&quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">echo</span> <span style="color: #000088;">$shakehand_key</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">?&gt;</span>&quot; /&gt;(6-20 chars)&lt;br /&gt;
<span style="color: #000000; font-weight: bold;">&lt;?php</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
&nbsp;
&nbsp;
<span style="color: #000000; font-weight: bold;">function</span> oather_section<span style="color: #009900;">&#40;</span><span style="color: #000088;">$section</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
	<span style="color: #b1b100;">return</span> <span style="color: #000088;">$section</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span>
<span style="color: #000000; font-weight: bold;">function</span> oather_options_validate<span style="color: #009900;">&#40;</span><span style="color: #000088;">$input</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> 
    <span style="color: #b1b100;">return</span> <span style="color: #000088;">$input</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">function</span> oather_options_page<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
<span style="color: #000000; font-weight: bold;">?&gt;</span>
    &lt;div class=&quot;wrap&quot;&gt;
        &lt;h2&gt;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">echo</span> tr<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'OATH_OTP'</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'oath'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&lt;/h2&gt;
        &lt;div class=&quot;narrow&quot;&gt;
            &lt;form action=&quot;options.php&quot; method=&quot;post&quot;&gt;
                &lt;p&gt;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">echo</span> tr<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'OATH_OTP目前仅有ios配对客户端,使用时间戳和shakehandKey结合认证.'</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'oath'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&lt;/p&gt;
                <span style="color: #000000; font-weight: bold;">&lt;?php</span> settings_fields<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'shakehand_key'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>
                <span style="color: #000000; font-weight: bold;">&lt;?php</span> do_settings_sections<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'oather'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>
                &lt;p class=&quot;submit&quot;&gt;
                    &lt;input name=&quot;submit&quot; type=&quot;submit&quot; class=&quot;button-primary&quot; value=&quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">echo</span> tr<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'Save Changes'</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'oath'</span><span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&quot; /&gt;
                &lt;/p&gt;
            &lt;/form&gt;
        &lt;/div&gt;
    &lt;/div&gt;
<span style="color: #000000; font-weight: bold;">&lt;?php</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
 <span style="color: #666666; font-style: italic;">//在设置页添加链接</span>
<span style="color: #000000; font-weight: bold;">function</span> oather_menu<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    add_options_page<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'OATH_OTP Settings'</span><span style="color: #339933;">,</span>  tr<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'OATH_OTP'</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'oath'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'manage_options'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oath_otp'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oather_options_page'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">function</span> oather_action_links<span style="color: #009900;">&#40;</span> <span style="color: #000088;">$links</span><span style="color: #339933;">,</span> <span style="color: #000088;">$file</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span> <span style="color: #000088;">$file</span> <span style="color: #339933;">!=</span> plugin_basename<span style="color: #009900;">&#40;</span> <span style="color: #009900; font-weight: bold;">__FILE__</span> <span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>
        <span style="color: #b1b100;">return</span> <span style="color: #000088;">$links</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$settings_link</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">'&lt;a href=&quot;options-general.php?page=oath_otp&quot;&gt;Settings&lt;/a&gt;'</span><span style="color: #339933;">;</span>
    <span style="color: #990000;">array_unshift</span><span style="color: #009900;">&#40;</span> <span style="color: #000088;">$links</span><span style="color: #339933;">,</span> <span style="color: #000088;">$settings_link</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">return</span> <span style="color: #000088;">$links</span><span style="color: #339933;">;</span>
    <span style="color: #666666; font-style: italic;">//在插件页添加链接</span>
<span style="color: #009900;">&#125;</span>
add_filter<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'plugin_action_links'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oather_action_links'</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">10</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
add_action<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'admin_menu'</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'oather_menu'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
&nbsp;
&nbsp;
<span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #990000;">isset</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$_POST</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'oather_shakehand_key'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>
	<span style="color: #666666; font-style: italic;">//update post</span>
	<span style="color: #000088;">$shakehand_len</span> <span style="color: #339933;">=</span> <span style="color: #990000;">strlen</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$_POST</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'oather_shakehand_key'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
		<span style="color: #b1b100;">if</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$shakehand_len</span> <span style="color: #339933;">&gt;=</span><span style="color: #cc66cc;">6</span>  <span style="color: #339933;">&amp;&amp;</span> <span style="color: #000088;">$shakehand_len</span> <span style="color: #339933;">&lt;=</span><span style="color: #cc66cc;">20</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span> 
		 	 update_option<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">'shakehand_key'</span><span style="color: #339933;">,</span> <span style="color: #000088;">$_POST</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'oather_shakehand_key'</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">,</span><span style="color: #0000ff;">''</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'yes'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> 
               <span style="color: #666666; font-style: italic;">//  print_r($_POST);   </span>
			 <span style="color: #000088;">$message</span> <span style="color: #339933;">=</span> __<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">&quot;Options saved.&quot;</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oath'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
		<span style="color: #009900;">&#125;</span><span style="color: #b1b100;">else</span><span style="color: #009900;">&#123;</span>
			 <span style="color: #000088;">$message</span> <span style="color: #339933;">=</span> tr<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">&quot;Options save failed,shakehand_key must be in 6 to 20 chars.&quot;</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'oath'</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
		 <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
&nbsp;
&nbsp;
 <span style="color: #000000; font-weight: bold;">?&gt;</span></pre></td></tr></table></div>

<p>&nbsp;</p>
					<div class="fixed"></div>
				</div>

				<div class="comments comments_single">
					<a href="index.html#respond">发表评论</a>
									</div>

				<!-- related posts START -->
								<!-- related posts END -->
			</div>


<script type="text/javascript" src="../../wp-content/themes/elegant-box/js/comment.js"></script>


	<div class="messagebox">
		<div class="content small">
			本文的评论功能被关闭了.		</div>
	</div>


			

	</div>

	<!-- sidebar START -->
<div id="sidebar">

<!-- Style Switcher START -->
<div class="widget">
	<div id="styleswitcher">
		<span id="style-text">主题风格: </span>
			<span id="style-green" class="color"><a onclick="TSS.setActiveStyleSheet('green');" href="javascript:void(0);" title="将主题风格更换为green"><img src="../../wp-content/themes/elegant-box/images/transparent.gif" alt="" /></a></span>
			<span id="style-purple" class="color"><a onclick="TSS.setActiveStyleSheet('purple');" href="javascript:void(0);" title="将主题风格更换为purple"><img src="../../wp-content/themes/elegant-box/images/transparent.gif" alt="" /></a></span>
			<span id="style-brown" class="color"><a onclick="TSS.setActiveStyleSheet('brown');" href="javascript:void(0);" title="将主题风格更换为brown"><img src="../../wp-content/themes/elegant-box/images/transparent.gif" alt="" /></a></span>
			<span id="style-blue" class="color"><a onclick="TSS.setActiveStyleSheet('blue');" href="javascript:void(0);" title="将主题风格更换为blue"><img src="../../wp-content/themes/elegant-box/images/transparent.gif" alt="" /></a></span>
			<span id="style-white" class="color"><a onclick="TSS.setActiveStyleSheet('white');" href="javascript:void(0);" title="将主题风格更换为white"><img src="../../wp-content/themes/elegant-box/images/transparent.gif" alt="" /></a></span>
			<span id="style-black" class="color"><a onclick="TSS.setActiveStyleSheet('black');" href="javascript:void(0);" title="将主题风格更换为black"><img src="../../wp-content/themes/elegant-box/images/transparent.gif" alt="" /></a></span>
		<div class="fixed"></div>
	</div>
</div>
<!-- Style Switcher END -->

		<!-- showcase -->
		
		<ul id="widgets">

<li class="widget widget_calendar"><h3>Archives</h3><div id="calendar_wrap"><table id="wp-calendar">
	<caption>2012 年七月</caption>
	<thead>
	<tr>
		<th scope="col" title="星期日">日</th>
		<th scope="col" title="星期一">一</th>
		<th scope="col" title="星期二">二</th>
		<th scope="col" title="星期三">三</th>
		<th scope="col" title="星期四">四</th>
		<th scope="col" title="星期五">五</th>
		<th scope="col" title="星期六">六</th>
	</tr>
	</thead>

	<tfoot>
	<tr>
		<td colspan="3" id="prev"><a href="../date/2012/05/index.html" title="查看 2012 年五月的文章">&laquo; 五</a></td>
		<td class="pad">&nbsp;</td>
		<td colspan="3" id="next" class="pad">&nbsp;</td>
	</tr>
	</tfoot>

	<tbody>
	<tr><td>1</td><td><a href="../date/2012/07/02/index.html" title="六月随笔">2</a></td><td>3</td><td>4</td><td><a href="../date/2012/07/05/index.html" title="ruby Rspec测试框架cheetsheet">5</a></td><td>6</td><td>7</td>
	</tr>
	<tr>
		<td>8</td><td><a href="../date/2012/07/09/index.html" title="linux下STAF执行失败时的处理">9</a></td><td>10</td><td>11</td><td>12</td><td id="today">13</td><td>14</td>
	</tr>
	<tr>
		<td>15</td><td>16</td><td>17</td><td>18</td><td>19</td><td>20</td><td>21</td>
	</tr>
	<tr>
		<td>22</td><td>23</td><td>24</td><td>25</td><td>26</td><td>27</td><td>28</td>
	</tr>
	<tr>
		<td>29</td><td>30</td><td>31</td>
		<td class="pad" colspan="4">&nbsp;</td>
	</tr>
	</tbody>
	</table></div></li><li class="widget widget_categories"><h3>分类目录</h3>		<ul>
	<li class="cat-item cat-item-7"><a href="../category/c_cplusplus/index.html" title="查看 C/C++ 下的所有文章">C/C++</a>
</li>
	<li class="cat-item cat-item-24"><a href="../category/ios-dev/index.html" title="查看 IOSDev 下的所有文章">IOSDev</a>
</li>
	<li class="cat-item cat-item-23"><a href="../category/java/index.html" title="查看 java 下的所有文章">java</a>
</li>
	<li class="cat-item cat-item-5"><a href="../category/lamp/index.html" title="查看 LAMP 下的所有文章">LAMP</a>
</li>
	<li class="cat-item cat-item-8"><a href="../category/onthego/index.html" title="查看 OnTheGo 下的所有文章">OnTheGo</a>
</li>
	<li class="cat-item cat-item-1"><a href="../category/other/index.html" title="查看 Other 下的所有文章">Other</a>
</li>
	<li class="cat-item cat-item-3"><a href="../category/project/index.html" title="查看 Project 下的所有文章">Project</a>
</li>
	<li class="cat-item cat-item-4"><a href="../category/rubytesting/index.html" title="查看 Ruby&amp;Testing 下的所有文章">Ruby&amp;Testing</a>
</li>
		</ul>
</li><li class="widget widget_text"><h3>Google Ads</h3>			<div class="textwidget"><script type="text/javascript"><!--
google_ad_client = "ca-pub-7220882232307827";
/* left_180x150, 创建于 09-2-19 */
google_ad_slot = "1136501676";
google_ad_width = 180;
google_ad_height = 150;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
</div>
		</li><li class="widget widget_tag_cloud"><h3>标签</h3><div class="tagcloud"><a href='../tag/c/index.html' class='tag-link-9' title='4 个话题' style='font-size: 22pt;'>c</a>
<a href='../tag/dailhelper/index.html' class='tag-link-13' title='1 个话题' style='font-size: 8pt;'>dailhelper</a>
<a href='../tag/linux/index.html' class='tag-link-14' title='1 个话题' style='font-size: 8pt;'>linux</a>
<a href='../tag/ls/index.html' class='tag-link-10' title='1 个话题' style='font-size: 8pt;'>ls</a>
<a href='../tag/makefile/index.html' class='tag-link-17' title='1 个话题' style='font-size: 8pt;'>makefile</a>
<a href='../tag/netkeeper/index.html' class='tag-link-16' title='1 个话题' style='font-size: 8pt;'>Netkeeper</a>
<a href='../tag/pcap/index.html' class='tag-link-25' title='1 个话题' style='font-size: 8pt;'>pcap</a>
<a href='../tag/ruby/index.html' class='tag-link-12' title='1 个话题' style='font-size: 8pt;'>ruby</a>
<a href='../tag/slab/index.html' class='tag-link-20' title='1 个话题' style='font-size: 8pt;'>slab</a>
<a href='../tag/wget/index.html' class='tag-link-11' title='1 个话题' style='font-size: 8pt;'>wget</a>
<a href='../tag/系%259F管%2590%2586/index.html' class='tag-link-15' title='1 个话题' style='font-size: 8pt;'>系统管理</a></div>
</li><li class="widget widget_links"><h3>链接表</h3>
	<ul class='xoxo blogroll'>
<li><a href="http://blog.csdn.net/Android_Tutor" rel="colleague" title="Android_Tutor的专栏" target="_blank">Android学习系列</a></li>
<li><a href="http://wpotp.com" rel="me" title="食品找茬网" target="_blank">找茬网</a></li>
<li><a href="http://www.sz95000.com/" title="深圳长途汽车网上订票，官方网站，这次不会忘记了。。。" target="_blank">深圳长途汽车网上订票</a></li>

	</ul>
</li>
<li class="widget widget_meta"><h3>功能</h3>			<ul>
			<li><a href="../../wp-login.php?action=register">注册</a></li>			<li><a href="../../wp-login.php">登录</a></li>
			<li><a href="../../feed/index.html" title="使用 RSS 2.0 订阅本站点内容">文章 <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="../../comments/feed/index.html" title="使用 RSS 订阅本站点的所有文章的近期评论">评论 <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="http://cn.wordpress.org/" title="基于 WordPress，一个优美、先进的个人信息发布平台。">WordPress.org</a></li>
						</ul>
</li>		</ul>

		<!-- showcase 2 -->
		
</div>
<!-- sidebar END -->

	<div class="fixed"></div>

		<div id="bottom">
			<div class="postnav">
				<span class="alignleft">&laquo; <a href="../190/index.html" rel="prev">UIView使用图片为背景和图片适应屏幕</a></span>
				<span class="alignright"><a href="../220/index.html" rel="next">ruby基本知识巩固</a> &raquo;</span>
				<div class="fixed"></div>
			</div>

			<div class="anchor">
				<span><a href="index.html#" onclick="MGJS.goTop();return false;">置顶</a></span>
			</div>
			<div class="fixed"></div>
			</div>
		<div class="fixed"></div>
	</div>
</div>

<!-- footer START -->
<div id="footer">
	<div class="inner">
		<div class="content">
			<p id="about">
				版权所有 &copy; 2008-2012 Only For Sunshine~ | 基于 <a href="http://wordpress.org/">WordPress</a> | 主题由 <a href="http://www.neoease.com/">NeoEase</a> 提供			</p>

			<ul id="admin">
				<li><a href="../../wp-login.php?action=register">注册</a></li>				<li><a href="../../wp-login.php">登录</a></li>
			</ul>

			<div class="fixed"></div>
		</div>
	</div>
</div><!-- footer END --><script type='text/javascript' src='http://s.gravatar.com/js/gprofiles.js?aa&#038;ver=3.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='../../wp-content/plugins/jetpack/modules/wpgroho.js?ver=3.4.1'></script>
	<div style="display:none">
	</div>

	<script src="http://stats.wordpress.com/e-201228.js" type="text/javascript"></script>
	<script type="text/javascript">
	st_go({v:'ext',j:'1:1.4.2',blog:'17044931',post:'202'});
	var load_cmc = function(){linktracker_init(17044931,202,2);};
	if ( typeof addLoadEvent != 'undefined' ) addLoadEvent(load_cmc);
	else load_cmc();
	</script><script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-9565349-1']);
  _gaq.push(['_setDomainName', 'imzc.net']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script> 
</body>
</html>
